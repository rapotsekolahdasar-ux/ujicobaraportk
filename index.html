<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TES PERBAIKAN CETAK - SUDAH BERHASIL</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== Theme & layout (biru muda, Arial) ===== */
    body { font-family: Arial, sans-serif; background:#e8f4fa; margin:0; padding:0; color:#222 }
    header { background:#6fb8f5; color:#fff; padding:14px 10px; text-align:center; font-size:20px; font-weight:700 }
    main { padding:18px; max-width:1100px; margin:0 auto 40px; }
    .menu-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:16px; margin-top:24px; }
    .menu-card { background:#fff; border-radius:12px; padding:20px; text-align:center; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.08); transition:.18s }
    .menu-card:hover { transform:translateY(-4px) }
    .menu-card span { display:block; font-size:34px; margin-bottom:8px }
    .card { background:#fff; padding:18px; border-radius:12px; box-shadow:0 6px 14px rgba(0,0,0,.06) }
    .nav-bar { display:flex; justify-content:space-between; gap:8px; background:#c6e5ff; border-radius:8px; padding:8px; margin-bottom:12px; align-items:center }
    .nav-bar button { background:#6fb8f5; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
    section { display:none; animation:fadein .35s ease; }
    @keyframes fadein { from {opacity:0} to {opacity:1} }
    #dashboard { display:block; text-align:center }
    input[type=text], select, textarea { padding:8px; border-radius:6px; border:1px solid #cfe9ff; background:#f8fcff; width:100%; box-sizing:border-box }
    textarea { resize:vertical }
    table { width:100%; border-collapse:collapse }
    table th, table td { padding:8px; border:1px solid #e6f4ff; text-align:left }
    .small { font-size:13px; color:#555 }
    .foto-grid { display:flex; gap:12px; flex-wrap:wrap }
    .foto-item { flex:1; min-width:160px; border:1px dashed #ddd; border-radius:8px; padding:8px; text-align:center; background:#fff }
    .foto-preview { width:100%; height:120px; border-radius:6px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#fafafa; color:#888 }
    .btn { background:#6fb8f5; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
    .muted { color:#666; font-size:13px }
    .top-right { position:fixed; right:18px; top:12px; display:flex; gap:8px; align-items:center }
    .hidden { display:none }
    .pilihan-horizontal { display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin-bottom:10px }
    .pill { background:#f0fbff; padding:6px 10px; border-radius:20px; border:1px solid #d6f0ff; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#333; color:#fff; padding:8px 14px; border-radius:8px; display:none }
    .tp-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding:6px 0; border-bottom:1px dotted #ddd; }
    .tp-text { flex:1; padding-right:15px; font-size:14px; }
    .penilaian-select { width: 140px; }

    /* Styling umum untuk semua sel penilaian */
    .table-responsive tr td {
        /* Tetapkan border yang rapi untuk semua sel */
        border: 1px solid #010407;
        /* Rata tengah isi (penting agar ceklis berada di tengah) */
        text-align: center;
        /* Atur lebar agar kotak-kotak tersebut seimbang */
        width: 60px; /* Sesuaikan lebar ini sesuai kebutuhan visual Anda */
    }
       

  /* Tambahkan jarak antar tabel yang berurutan */
  table + table {
    margin-top: 8mm !important;
  }

  /* Pemisah halaman yang rapi */
  .page-break {
    display: block;
    height: 20mm; /* jarak antar halaman */
    page-break-before: always !important;
  }


    
    /* Hindari blok dokumentasi terbelah dua halaman */
    .dokumentasi-area {
        page-break-inside: avoid !important;
        margin-top: 10mm !important;
        margin-bottom: 10mm !important;
    }

    /* Beri jarak antar elemen raport */
    .elemen-raport-block {
        margin-top: 12mm !important;
        margin-bottom: 12mm !important;
        page-break-inside: avoid !important;
    }

    /* Jika tetap mepet antar halaman, tambahkan jeda otomatis */
    .elemen-raport-block + .elemen-raport-block::before {
        content: "";
        display: block;
        height: 15mm; /* jarak ekstra di antara blok */
    }
    
    .raport-container:last-child {
        page-break-after: auto;    /* halaman terakhir tidak diberi jeda ekstra */
    }

    body {
        background: white !important;
    }
    


    /* üéØ KODE UTAMA: Menargetkan sel yang KOSONG */
    /* Metode 1: Menggunakan pseudo-class :empty */
    .table-responsive tr td:empty {
        /* Menghapus semua yang terlihat dari sel kosong */
        border: none !important; /* Hilangkan garis kotak */
        padding: 0; /* Hilangkan ruang di dalam sel */
        margin: 0; /* Hilangkan ruang di luar sel */
        width: 0; /* Paksa lebar menjadi nol */
        height: 0; /* Paksa tinggi menjadi nol */
        font-size: 0; /* Pastikan tidak ada spasi yang tersisa */
        visibility: hidden; /* Secara eksplisit menyembunyikannya */
}

/* Styling untuk Sel yang Terisi (Contoh: Menampilkan Kotak) */
.nilai-terisi {
    /* Border agar kotak ceklis terlihat jelas */
    border: 1px solid #dee2e6;
    /* Rata tengah dan padding agar ceklis terlihat rapi */
    text-align: center;
    padding: 8px 5px; 
    /* Lebar kolom penilaian (opsional) */
    width: 60px;
}

/* üöÄ KODE UTAMA: Styling untuk Sel yang Kosong (Menghilangkan Kotak) */
.nilai-kosong {
    /* Perintah terkuat untuk menyembunyikan elemen */
    display: none !important; 
    
    /* Tambahan pengamanan agar tidak ada ruang yang tersisa */
        border: none !important; 
        padding: 0 !important;
        width: 0 !important;
        min-width: 0 !important;
        margin: 0 !important;
    }
        
    /* ===== NEW RAPORT FORMAT STYLES (Word Doc Style) ===== */
    .raport-container { 
      border: none; 
      padding: 0; 
      margin-top: 15px; 
      background: white; 
      box-shadow: 0 0 10px rgba(0,0,0,.1); 
      max-width: 200mm; 
      font-size: 11pt; 
      min-height: 287mm; 
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box; 
    }

    /* ********* Perbaikan Margin Cetak ********* */
    @media print, screen and (max-width: 200mm) {
      .raport-container {
        padding: 15mm 15mm 10mm 15mm; 
        max-width: 210mm; 
        box-shadow: none;
      }
    }
    /* **************************************** */
    
    .raport-header h2, .raport-header h3, .raport-header h4 { margin: 0; padding: 0; }
    .raport-header h2 { font-size: 16px; }
    .raport-header h3 { font-size: 18px; font-weight: bold; }
    .raport-header h4 { font-size: 14px; }

    .raport-table-identity { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
    .raport-table-identity td { padding: 4px 0; border: none; font-size: 14px; }
    
    .elemen-raport-block { margin-top: 20px; border: 1px solid #222; page-break-inside: avoid; }
    .elemen-raport-block h4 { 
      background-color: #f2f2f2; 
      padding: 6px 10px; 
      border-bottom: 1px solid #222; 
      margin: 0; 
      font-size: 15px; 
      font-weight: bold; 
    }
    
    .elemen-content-block { padding: 10px; font-size: 14px; line-height: 1.4; }
    .deskripsi-area { margin-bottom: 15px; }
    .saran-area { margin-bottom: 15px; } 
    .dokumentasi-area { border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px; }


    /* Perubahan 1: Memperbesar ukuran foto cetak */
    .raport-photos-block { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; margin-top: 5px; }
    .raport-photos-block .foto-item-cetak { width: 120px; height: 120px; border: 1px solid #ddd; overflow: hidden; flex-shrink: 0;} /* Ditingkatkan dari 90px */
    .raport-photos-block .foto-item-cetak img { width: 100%; height: 100%; object-fit: cover; }

    .presensi-table { width: 500px; margin: 10px 0 10px 0; } 
    .presensi-table th, .presensi-table td { border: 1px solid rgb(252, 251, 251); padding: 5px; text-align: left; }
    .presensi-table th { background-color: #faf8f8; }

    .raport-ttd table { width: 100%; margin-top: 40px; border: none; font-size: 14px; }
    .raport-ttd td { border: none; padding: 10px; text-align: center; width: 33.33%; }
    .raport-ttd .signature-line { height: 60px; }
    
    /* ===== New Login/Lock styles (Grayscale) ===== */
    .grayscale-mode {
      filter: grayscale(100%);
      pointer-events: none; /* Lock all interactions */
    }
    /* Exclude login area/toast from grayscale filter & re-enable clicks on them */
    .grayscale-mode .top-right, .grayscale-mode #toast, .grayscale-mode #loginKeyIcon, .grayscale-mode .login-form {
      filter: none;
      pointer-events: auto;
    }
    
    .icon-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
    }
    .icon-eye {
      position: absolute;
      right: 8px;
      top: 30px; 
      cursor: pointer;
      color: #6fb8f5;
      font-size: 16px;
    }
    .login-form {
      animation: fadein .2s ease;
      position: absolute; 
      right: 0; 
      top: 50px; 
      z-index: 100;
      min-width: 280px;
      padding: 15px;
      text-align: left;
    }
    
    /* Style untuk kolom prestasi di tabel siswa */
    #tabelSiswa textarea {
        min-width: 150px;
        height: 60px;
        font-size: 12px;
        resize: vertical;
    }
    /* ==== PERBAIKAN CETAK PDF (TABEL TIDAK PECAH & ADA JARAK HALAMAN) ==== */
    @media print {
    table {
        page-break-inside: avoid;   /* Hindari tabel terpotong di tengah halaman */
        margin-bottom: 18mm;        /* Tambahkan jarak antar tabel */
    }

    tr, td, th {
        page-break-inside: avoid;   /* Hindari baris pecah di tengah */
    }

    thead {
        display: table-header-group; /* Header tabel ikut di halaman berikutnya */
        background-color: white;
    }

    tfoot {
        display: table-footer-group;
    }

    /* Pastikan setiap blok raport punya jarak antar halaman */
    .raport-container {
        page-break-after: always;
        margin: 20mm auto;
        padding: 15mm;
    }

    .raport-container:last-child {
        page-break-after: auto;
    }

    /* Tambahkan sedikit jarak antar bagian tabel raport */
    .elemen-raport-block {
        margin-bottom: 15mm;
        page-break-inside: avoid;
    }
    }

/* Aturan yang hanya berlaku saat mencetak atau dikonversi ke PDF */

/* Terapkan pada elemen DIV yang membungkus tabel utama raport */
/* Ganti '.tabel-utama' dengan class/ID pembungkus tabel Anda */
.tabel-utama,
.table-responsive {
    /* Mencegah pemotongan di tengah tabel */
    page-break-inside: avoid; 
}

/* ‚ö†Ô∏è TAMBAHKAN INI: Memaksa halaman untuk putus SETELAH elemen. */
/* Jika Anda memiliki banyak tabel, ini akan memastikan pemisahan */
.tabel-akhir-halaman {
    page-break-after: always;
    /* Memberi jarak/margin di akhir halaman sebelum break */
    margin-bottom: 20mm; 
}
/* Memastikan header tabel muncul di setiap halaman baru */
table thead {
    display: table-header-group; /* üîë KUNCI: Memastikan thead diulang */
    /* Opsional: Membuat header tetap terlihat saat di-scroll */
    position: sticky; 
    top: 0; 
    background-color: white; /* Penting agar teks tidak bertabrakan */
}

/* Pastikan elemen <tr> di dalam tabel tidak terpotong */
table tr {
    page-break-inside: avoid !important;
}
/* ======================================================= */
/* ===== PERBAIKAN CETAK V4 (METODE NORMAL FLOW)       ===== */
/* ======================================================= */
/* ======== PERBAIKAN CETAK PDF (RAPI DAN PROPORSIONAL) ======== */
@media print {
  /* Ukuran halaman A4 */
  @page {
    size: A4 portrait;
    margin: 15mm 15mm 15mm 15mm; /* margin kiri-kanan-atas-bawah */
  }

  /* Pastikan raport berada di tengah halaman */
  .raport-container {
    max-width: 180mm !important;
    margin: 0 auto 15mm auto !important;
    padding: 12mm !important;
    box-shadow: none !important;
    background: #fff !important;
    page-break-after: always !important;
  }

  /* Hindari elemen terpotong antar halaman */
  .elemen-raport-block,
  .raport-ttd,
  .presensi-table,
  table {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }

  /* Pemisah halaman antar raport */
  .page-break {
    page-break-before: always !important;
    height: 0 !important;
  }

  /* Sembunyikan elemen UI lain */
  header, .menu-grid, .nav-bar, .btn, #toast, .top-right {
    display: none !important;
  }

  /* Warna latar belakang putih bersih */
  body {
    background: white !important;
  }
}
/* ===== SEMBUNYIKAN BAGIAN PILIH SISWA SAAT CETAK ===== */
@media print {
  label[for="pilihSiswaCetak"],
  #pilihSiswaCetak,
  section#raport h3,
  section#raport .btn {
    display: none !important;
    visibility: hidden !important;
  }
}
/* ===== SEMBUNYIKAN BARIS PILIH SISWA SAAT CETAK ===== */
@media print {
  section#raport > .card > div:first-of-type {
    display: none !important;
    visibility: hidden !important;
  }

  /* Tambahan: pastikan tombol juga hilang */
  section#raport .btn {
    display: none !important;
  }
}


  </style>
</head>
<body>
  <header>e-Raport Deep Learning TK ‚Äî Deep Learning</header>

  <div class="top-right">
    <button id="loginKeyIcon" class="icon-btn" onclick="toggleLoginForm()">
      üîì
    </button>
    
    <div id="loginForm" class="login-form hidden card">
      <p style="font-weight: bold; margin-bottom: 10px;">Login Guru</p>
      <div style="margin-bottom: 10px;">
        <label class="small">Username:</label>
        <input type="text" id="loginUsername" placeholder="guru" value="guru">
      </div>
      <div style="margin-bottom: 15px; position: relative;">
        <label class="small">Password:</label>
        <input type="password" id="loginPassword" placeholder="Password Anda" style="padding-right: 30px;">
        <span id="togglePassword" class="icon-eye" onclick="togglePasswordVisibility()">
          üëÅÔ∏è
        </span>
      </div>
      <button class="btn" onclick="handleLogin()" style="width: 100%;">Masuk</button>
      
      <a href="#" onclick="resetPassword(event)" style="display:block; margin-top:10px; font-size:12px; text-align:center;">Lupa Password? (klik tobol terkunci)</a>
    </div>
    
    <div id="userBadge" class="muted">
      ‚úÖ <span id="userName">Guru (Developer)</span>
    </div>
  </div>

  <main>
    <section id="dashboard">
      <img id="logoDashboard" src="" alt="Logo Sekolah" style="max-height:110px; display:block; margin:12px auto;">
      <h2>Selamat Datang ‚Äî e-Raport Deep Learning TK</h2>
      <p class="muted">Aplikasi ringan untuk membantu guru TK dalam menyusun raport secara cepat dan rapi. **Semua menu sudah aktif.**</p>

      <div class="menu-grid" id="menuGrid">
        <div class="menu-card" id="mDataSiswa" onclick="showSection('dataSiswa')">
          <span>üë©‚Äçüëß‚Äçüë¶</span>Data Siswa & Presensi
        </div>
        <div class="menu-card" id="mATP" onclick="showSection('alurTujuan')">
          <span>üéØ</span>Alur Tujuan Pembelajaran
        </div>
        <div class="menu-card" id="mIntra" onclick="showSection('intraKurikuler')">
          <span>üìò</span>Intra Kurikuler
        </div>
        <div class="menu-card" id="mKokur" onclick="showSection('koKurikuler')">
          <span>üìó</span>Ko Kurikuler
        </div>
        <div class="menu-card" id="mMuatanLokal" onclick="showSection('muatanLokal')">
          <span>üá≤üá®</span>Muatan Lokal
        </div>
        <div class="menu-card" id="mRaport" onclick="showSection('raport')">
          <span>üßæ</span>Raport
        </div>
        <div class="menu-card" id="mPengaturan" onclick="showSection('pengaturan')">
          <span>‚öôÔ∏è</span>Pengaturan Sekolah
        </div>
      </div>
      <p class="muted" style="margin-top:10px">TIM eRAPORT & PENELAAH KURIKULUM TK</p>
      <p class="muted" style="margin-top:10px">RAFII HAMDI,M.Pd</p>
      <p class="muted" style="margin-top:10px">NURMA DINA IRAMA,S.Pd</p>
      <p class="muted" style="margin-top:10px">SOLIKHAH,S.Pd</p>
      <p class="muted" style="margin-top:10px">@creative-by-rafi</p>
    </section>

    <section id="dataSiswa">
      <div class="card">
        <div style="margin-bottom: 15px;">
            <button onclick="showSection('dashboard')">üè† Kembali</button>
        </div>
        
        <div class="nav-bar" style="background: none; padding: 0; margin-bottom: 20px;">
          <div class="pilihan-horizontal" style="justify-content: flex-start; gap: 20px;">
            <div style="min-width:220px">
              <label>üìã Tempel data dari Excel (Nama[TAB]NISN[TAB]Kelas)</label>
              <textarea id="inputSiswa" rows="6" placeholder="Contoh: Ani\t12345\tA"></textarea>
              <div style="margin-top:8px"><button class="btn" onclick="importSiswa()">üì• Import Data</button> <button class="btn" onclick="tampilkanSiswa()">üëÄ Lihat Data</button></div>
            </div>
            <div style="min-width:220px">
              <label>Tambah Manual</label>
              <input type="text" id="namaManual" placeholder="Nama siswa">
              <input type="text" id="nisnManual" placeholder="NISN (opsional)" style="margin-top:6px">
              <input type="text" id="kelasManual" placeholder="Kelas" style="margin-top:6px">
              <div style="margin-top:8px"><button class="btn" onclick="tambahManual()">‚ûï Tambah</button></div>
            </div>
          </div>
        </div>

        <h3>Daftar Siswa (dengan Kolom Prestasi)</h3>
        <div id="tabelSiswa" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="alurTujuan">
      <div class="card">
        <div class="nav-bar">
          <button onclick="showSection('dataSiswa')">‚¨ÖÔ∏è Kembali</button>
          <button onclick="showSection('intraKurikuler')">‚è≠Ô∏è Lanjut Intra</button>
        </div>
        <h3>Alur Tujuan Pembelajaran (ATP)</h3>

        <div class="pilihan-horizontal">
          <div class="pill">
            <label>Pilih Siswa</label>
            <select id="pilihSiswaATP" onchange="onSiswaChangeATP()"><option value="">-- pilih siswa --</option></select>
          </div>
          <div class="pill">
            <label>Kelas (otomatis)</label>
            <input type="text" id="kelasATP" readonly>
          </div>
          <div class="pill">
            <label>Jenis Penilaian</label>
            <select id="jenisATP" onchange="onJenisChangeATP()">
                <option value="Intra">Intra Kurikuler (Merdeka)</option>
                <option value="KoKur">KoKur (P5)</option>
                <option value="MuLok">Muatan Lokal</option> 
            </select>
          </div>
        </div>
        
        <hr style="margin: 15px 0; border: none; border-top: 1px dashed #ddd;">

        <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap">
          <div style="flex:1; min-width:260px">
            <label>Elemen</label>
            <select id="selectElemen" onchange="onElemenChange()"></select>
          </div>
          <div style="width:160px">
            <label>Fase</label>
            <select id="selectFase" onchange="onFaseChange()"></select>
          </div>
        </div>

        <hr style="margin: 15px 0; border: none; border-top: 1px dashed #ddd;">

        <h4 id="judulDaftarTP" style="display:none; color:#333;">Daftar Tujuan Pembelajaran (Sub Elemen) & Penilaian</h4>
        
        <div style="display:flex; justify-content:flex-end; align-items:flex-end; margin-bottom: 5px;">
            <div style="width:140px; text-align:right; font-weight:bold; color:#0056b3;">Penilaian Guru</div>
        </div>
        
        <div id="daftarTujuanPembelajaran" style="margin-top:4px; min-height: 50px;">
          <div class="muted">Pilih Siswa, Elemen, dan Fase untuk menampilkan daftar Tujuan Pembelajaran.</div>
        </div>

        <div style="margin-top:10px">
          <button class="btn" onclick="simpanATP()">üíæ Simpan Semua Penilaian di Atas</button>
        </div>
        
      </div>
    </section>

    <section id="intraKurikuler">
      <div class="card">
        <div class="nav-bar">
          <button onclick="showSection('alurTujuan')">‚¨ÖÔ∏è Kembali</button>
          <button onclick="showSection('koKurikuler')">‚è≠Ô∏è Lanjut KoKur</button>
        </div>
        <h3>Intra Kurikuler</h3>
        <div class="muted small">Nama siswa: <strong id="intraNama">-</strong></div>
        <div style="margin-top:8px">
          <h4>Nilai Agama & Budi Pekerti (Otomatis dari ATP)</h4>
          <textarea id="deskAgama" rows="3" placeholder="Deskripsi akan terisi otomatis dari penilaian ATP. Anda bisa mengeditnya di sini."></textarea>
          <div class="foto-grid" id="fotoGridAgama" style="margin-top:8px"></div>
        </div>
        <hr>
        <div style="margin-top:8px">
          <h4>Jati Diri (Otomatis dari ATP)</h4>
          <textarea id="deskJatidiri" rows="3" placeholder="Deskripsi akan terisi otomatis dari penilaian ATP. Anda bisa mengeditnya di sini."></textarea>
          <div class="foto-grid" id="fotoGridJatidiri" style="margin-top:8px"></div>
        </div>
        <hr>
        <div style="margin-top:8px">
          <h4>Literasi, Matematika, Sains, Teknologi, Rekayasa & Seni (Otomatis dari ATP)</h4>
          <textarea id="deskLiterasi" rows="3" placeholder="Deskripsi akan terisi otomatis dari penilaian ATP. Anda bisa mengeditnya di sini."></textarea>
          <div class="foto-grid" id="fotoGridLiterasi" style="margin-top:8px"></div>
        </div>
        <hr>
        <div style="margin-top:8px">
          <h4>Refleksi/Catatan Orang Tua</h4>
          <textarea id="catatanOrtu" rows="3" placeholder="Catatan atau masukan dari orang tua mengenai perkembangan anak."></textarea>
        </div>
        <div style="margin-top:12px"><button class="btn" onclick="simpanIntra()">üíæ Simpan Deskripsi Intra</button></div>
      </div>
    </section>

    <section id="koKurikuler">
      <div class="card">
        <div class="nav-bar">
          <button onclick="showSection('intraKurikuler')">‚¨ÖÔ∏è Kembali</button>
          <button onclick="showSection('muatanLokal')">‚è≠Ô∏è Lanjut Muatan Lokal</button>
        </div>
        <h3>Ko Kurikuler</h3>
        <div class="muted small">Nama siswa: <strong id="kokurNama">-</strong></div>
        <label>Deskripsi Capaian Proyek P5/P-RBL (Otomatis dari ATP KoKur)</label>
        <textarea id="deskKokur" rows="3" placeholder="Deskripsi akan terisi otomatis dari penilaian ATP. Anda bisa mengeditnya di sini."></textarea>
        <label style="margin-top:8px">Refleksi/Catatan Guru (Digunakan di Raport Intra/KoKur)</label>
        <textarea id="catatanGuru" rows="3"></textarea>
        <div class="foto-grid" id="fotoGridKokur" style="margin-top:8px"></div>
        <div style="margin-top:12px"><button class="btn" onclick="simpanKokur()">üíæ Simpan Deskripsi KoKur</button></div>
      </div>
    </section>

    <section id="muatanLokal">
      <div class="card">
        <div class="nav-bar">
          <button onclick="showSection('koKurikuler')">‚¨ÖÔ∏è Kembali</button>
          <button onclick="showSection('raport')">‚è≠Ô∏è Lanjut Raport</button>
        </div>
        <h3>Muatan Lokal</h3>
        <div class="muted small">Nama siswa: <strong id="mulokNama">-</strong></div>
        
        <label>Deskripsi Capaian Muatan Lokal (Otomatis dari ATP MuLok)</label>
        <textarea id="deskMulok" rows="3" placeholder="Deskripsi akan terisi otomatis dari penilaian ATP. Anda bisa mengeditnya di sini."></textarea>
        
        <label style="margin-top:8px">Refleksi/Catatan Guru untuk Muatan Lokal</label>
        <textarea id="catatanGuruMulok" rows="3"></textarea>
        
        <div class="foto-grid" id="fotoGridMulok" style="margin-top:8px"></div>
        <div style="margin-top:12px"><button class="btn" onclick="simpanMuatanLokal()">üíæ Simpan Deskripsi Muatan Lokal</button></div>
      </div>
    </section>

    <section id="raport">
      <div class="card">
        <div class="nav-bar">
          <button onclick="showSection('muatanLokal')">‚¨ÖÔ∏è Kembali</button>
          <button onclick="showSection('dashboard')">üè† Kembali ke Beranda</button>
        </div>
        <h3>Cetak Raport</h3>
        
        <div style="display:flex; gap:8px; flex-wrap: wrap; align-items:center; margin-bottom:10px">
          <label>Pilih Siswa:</label>
          <select id="pilihSiswaCetak"></select>
          <button class="btn" onclick="prepareCetak('intra')">Lihat & Download Intra</button>
          <button class="btn" onclick="prepareCetak('kokur')">Lihat & Download KoKur</button>
          <button class="btn" onclick="prepareCetak('mulok')">Lihat & Download MuLok</button>
        </div>
        <div id="previewCetak" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="pengaturan">
      <div class="card">
        <div class="nav-bar">
          <button onclick="showSection('dashboard')">üè† Kembali</button>
        </div>
        <h3>Pengaturan Sekolah</h3>
        <label>Nama Sekolah (Nama Lengkap, ex: TK Tanah Bumbu</label>
        <input type="text" id="namaSekolah">
        <label>Nama Yayasan/Lembaga (Opsional)</label>
        <input type="text" id="namaYayasan">
        <label>Alamat Sekolah (Detail, ex: Jl. Lesehan Komplek Griya Asri No. 79 Rt. 05 Ds Kersik Putih Kec Batulicin Kab. Tanah Bumbu Prov Kalimantan selatan)</label>
        <input type="text" id="alamatSekolah">
        <label>Kontak Sekolah (HP/Email, ex: HP : 0821 4310 2821 &nbsp; Email : permatahati.tanbukab@gmail.com)</label>
        <input type="text" id="kontakSekolah">
        <hr style="margin: 15px 0;">
        <label>Nama Kepala Sekolah</label>
        <input type="text" id="kepalaSekolah">
        <label>NIP/NIK Kepala Sekolah</label>
        <input type="text" id="nipKepsek">
        <label>Nama Guru Kelas</label>
        <input type="text" id="guruKelas">
        <label>NIP/NIK Guru</label>
        <input type="text" id="nipGuru">
        <label>Tahun Ajaran</label>
        <input type="text" id="tahunAjaran" placeholder="2025/2026">
        <label>Semester</label>
        <input type="text" id="semester" placeholder="1 atau 2">
        <label>Tanggal Rapor (Kota, dd MMMM yyyy)</label>
        <input type="text" id="tanggalRapor" placeholder="Contoh: Batulicin, 21 Desember 2025">
        <label style="margin-top:8px">Upload Logo Sekolah</label>
        <input type="file" id="logoInput" accept="image/*">
        <img id="logoPreview" style="display:block; max-height:90px; margin-top:8px" alt="Preview Logo">

        <h4 style="margin-top:14px"></h4>
        <div id="timPengembangArea">
          <table id="timTable"><tr><th></th><th></th></tr></table>
        </div>

        <div style="margin-top:10px"><button class="btn" onclick="simpanPengaturan()">üíæ Simpan</button></div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    /* ===========================
       MASTER ATP (elemen -> fase -> sub-elemen)
       [Data diambil dari file ALUR TUJUAN PEMBELAJARAN TK PERMATA 2025.docx dan Muatan Lokal .docx]
       =========================== */
    const MASTER_ATP = [
      {
        elemen: "Nilai Agama Dan Budi Pekerti",
        fase: ["Usia 4-5 Tahun", "Usia 5-6 Tahun"],
        sub: {
          "Usia 4-5 Tahun": [
            "KELOMPOK 1: Murid percaya kepada Tuhan YME, mengenal dan mempraktekkan ajaran pokok agama dan kepercayaannya",
            "TP 1. Anak dapat mengetahui agama yang dianutnya.",
            "TP 2. Meniru gerakan beribadah dengan urutan yang benar",
            "TP 3. Mengucapkan doa sebelum dan/atau sesudah melakukan sesuatu",
            "TP 4. Mengenal kalimat tayyibah (basmallah, alhamdulillah, subhanallah, dll)",
            "TP 5. Menerapkan kata (tolong, terimakasih, maaf, dll) dalam keseharian",
            "TP 6. Mengucapkan terima kasih",
            "---",
            "KELOMPOK 2: Murid menghargai diri sendiri dan memiliki rasa Syukur terhadap Tuhan YME",
            "TP 1. Mengembalikan mainan setelah digunakan",
            "TP. 2 Berpartisipasi aktif menjaga kebersihan lingkungan sekitarnya",
            "TP 3. Membuang sampah pada tempatnya",
            "TP 4. Mencuci tangan sebelum makan dan sesudah makan",
            "TP 5. Mengetahui tentang kebersihan diri sendiri",
            "---",
            "KELOMPOK 3: Murid menghargai sesama manusia dengan various perbedaannya",
            "TP 1. Mengenal perilaku baik/sopan dan buruk",
            "TP 2. Membiasakan diri berperilaku baik",
            "TP 3. Mengucapkan salam dan menjawab salam",
            "TP 4. Berani meminta maaf dan memberi maaf",
            "TP 5. Mengenal makna kata (tolong, terimakasih, maaf, dll)",
            "TP 6. Dapat membedakan perbuatan baik dan buruk",
            "TP 7. Menyayangi teman",
            // KOREKSI TP DUPLIKAT: TP 8 & TP 9 DUA KALI
            "TP 8. Menghargai orang yang sedang berbicara",
            "TP 9. Bersikap ramah",
            "TP 10. Mau berbagi, menolong, dan membantu teman",
            "TP 11. Meminta maaf ketika berbuat salah",
            "TP 12. Menghargai orang lain", // Dihapus 1 duplikasi TP 12
            "---",
            "KELOMPOK 4: Murid menghargai alam dan seluruh makhluk hidup ciptaan Tuhan YME",
            "TP 1. Menghormati guru dan orang tua",
            "TP 2. Bergotong royong",
            "TP 3. Menjaga diri sendiri dari lingkungannya",
            "TP 4. Berpartisipasi menjaga kebersihan lingkungan"
          ],
          "Usia 5-6 Tahun": [
            "KELOMPOK 1: Murid percaya kepada Tuhan YME, mengenal agama yang dianut dan mempraktekkan ajaran pokok agama dan kepercayaannya",
            "TP 1. Mengenal Tuhan YME, agama yang dianut, dan mempraktekkan ajaran pokok agama/kepercayaan (contoh: sholat, mengaji, mengikuti upacara agama)",
            "TP 2. Mengenal kalimat tayyibah, menyebutkan rukun Islam dan rukun Iman",
            "TP 3. Mengucapkan doa sebelum dan sesudah melakukan sesuatu dengan tertib",
            "TP 4. Menerapkan kata (tolong, terimakasih, maaf, dll) dalam keseharian dengan kesadaran",
            "TP 5. Mengenal lebih banyak kalimat tayyibah dan mengucapkannya saat beraktifitas",
            "TP 6. Mengucapkan rasa syukur atas nikmat yang diperoleh",
            "---",
            "KELOMPOK 2: Murid menghargai diri sendiri dan memiliki rasa Syukur terhadap Tuhan YME",
            "TP 1. Mengembalikan mainan dan merapikan alat belajar setelah digunakan secara mandiri",
            "TP 2. Berpartisipasi aktif menjaga kebersihan dan kerapihan lingkungan sekolah dan rumah",
            "TP 3. Membuang sampah pada tempatnya dan memisahkan sampah (organik/anorganik) jika sudah dikenalkan",
            "TP 4. Mencuci tangan dan menjaga kebersihan diri (mandi, menggosok gigi) secara mandiri",
            "TP 5. Mengetahui tentang kesehatan diri sendiri dan gizi sederhana",
            "TP 6. Mengucapkan syukur atas diri sendiri",
            "---",
            "KELOMPOK 3: Murid menghargai sesama manusia dengan various perbedaannya",
            "TP 1. Mengenal dan membiasakan diri berperilaku baik/sopan dalam keseharian",
            "TP 2. Mengucapkan salam dan menjawab salam dengan sopan",
            "TP 3. Berani meminta maaf dan memberi maaf",
            "TP 4. Menghargai orang yang sedang berbicara dan menunggu giliran",
            "TP 5. Bersikap ramah, mau berbagi, menolong, dan membantu teman",
            "TP 6. Menghargai orang lain dan menerima perbedaan dengan senang hati",
            "TP 7. Membiasakan diri berperilaku baik dan mengetahui konsekuensi perbuatan buruk",
            "TP 8. Berbagi mainan dan benda milik sendiri",
            "TP 9. Menyimpan makanan dan minuman di tempat yang benar",
            "TP 10. Makan tanpa bantuan",
            "TP 11. Tidak memilih-milih makanan (tidak hanya makan makanan ringan)",
            "---",
            "KELOMPOK 4: Murid menghargai alam dan seluruh makhluk hidup ciptaan Tuhan YME",
            "TP 1. Menghormati guru dan orang tua serta orang dewasa lainnya",
            "TP 2. Bergotong royong dalam membersihkan lingkungan kelas/sekolah",
            "TP 3. Menjaga diri sendiri dari lingkungannya (safety awareness)",
            "TP 4. Berpartisipasi menjaga kebersihan lingkungan dengan inisiatif sendiri",
            "TP 5. Mengenal berbagai jenis tanaman dan hewan"
          ]
        }
      },
      {
        elemen: "Jati Diri",
        fase: ["Usia 4-5 Tahun", "Usia 5-6 Tahun"],
        sub: {
          "Usia 4-5 Tahun": [
            "KELOMPOK 1: Murid mengenali dan menghargai diri sendiri serta orang lain",
            "TP 1. Mengenal identitas diri (nama, usia, jenis kelamin, alamat)",
            "TP 2. Mengekspresikan emosi dan merespons emosi yang kuat",
            "TP 3. Memahami dan mematuhi aturan/rutinitas kelas",
            "TP 4. Mengenal anggota keluarga (inti)",
            "TP 5. Menghargai dan merayakan keberagaman teman",
            "TP 6. Mengetahui organ tubuh vital dan fungsinya",
            "TP 7. Mengetahui tentang penyakit sederhana yang sering diderita",
            "---",
            "KELOMPOK 2: Murid berperilaku secara mandiri dan disiplin",
            "TP 1. Memakai dan melepas pakaian sendiri",
            "TP 2. Membereskan mainan/alat sendiri setelah digunakan",
            "TP 3. Melakukan tugas sederhana tanpa bantuan",
            "TP 4. Mencuci tangan dan menggosok gigi",
            "TP 5. Makan dan minum sendiri",
            "TP 6. Berani mencoba hal baru",
            "TP 7. Mengambil keputusan sederhana untuk diri sendiri",
            "TP 8. Berani tampil di depan umum",
            "TP 9. Berani bertanya dan menjawab pertanyaan",
            "TP 10. Berani mengakui kesalahan dan minta maaf",
            "---",
            "KELOMPOK 3: Murid memiliki kemampuan untuk berinteraksi dan mengelola emosi",
            "TP 1. Berinteraksi dengan teman sebaya dan orang dewasa",
            "TP 2. Mengambil keputusan sederhana secara berkelompok/diskusi",
            "TP 3. Menunjukkan minat untuk mengenal dan berbagi pengalaman dengan orang lain",
            "TP 4. Memahami dan menanggapi emosi orang lain (empati)",
            "TP 5. Mengenal dan mengatur emosi sendiri"
          ],
          "Usia 5-6 Tahun": [
            "KELOMPOK 1: Murid mengenali dan menghargai diri sendiri serta orang lain",
            "TP 1. Mengenal identitas diri (nama, usia, jenis kelamin, alamat) dengan lebih lengkap",
            "TP 2. Mengekspresikan emosi dan memilih cara sehat untuk merespons emosi yang kuat",
            "TP 3. Memahami dan mematuhi aturan/rutinitas kelas dengan kesadaran penuh",
            "TP 4. Mengenal anggota keluarga besar dan perannya",
            "TP 5. Menghargai dan merayakan keberagaman teman dan budaya",
            "TP 6. Mengetahui organ tubuh vital dan fungsinya",
            "TP 7. Mengetahui tentang penyakit sederhana yang sering diderita",
            "---",
            "KELOMPOK 2: Murid berperilaku secara mandiri dan disiplin",
            "TP 1. Memakai dan melepas pakaian sendiri dan dapat merawat pakaiannya",
            "TP 2. Membereskan mainan/alat sendiri setelah digunakan secara inisiatif",
            "TP 3. Melakukan tugas sederhana tanpa bantuan, dapat menyelesaikan tugas hingga akhir",
            "TP 4. Mencuci tangan, menggosok gigi, dan merawat kebersihan diri lainnya secara mandiri",
            "TP 5. Makan dan minum sendiri dengan tertib",
            "TP 6. Berani mencoba hal baru dan pantang menyerah",
            "TP 7. Mengambil keputusan sederhana untuk diri sendiri dengan alasan yang jelas",
            "TP 8. Berani tampil di depan umum dan mengekspresikan ide",
            "TP 9. Berani bertanya, menjawab pertanyaan, dan berdiskusi",
            "TP 10. Berani mengakui kesalahan, minta maaf, dan berusaha memperbaiki",
            "TP 11. Merawat barang milik sendiri dan milik orang lain",
            "---",
            "KELOMPOK 3: Murid memiliki kemampuan untuk berinteraksi dan mengelola emosi",
            "TP 1. Berinteraksi dengan teman sebaya dan orang dewasa dengan sopan dan percaya diri",
            "TP 2. Mengambil keputusan sederhana secara berkelompok/diskusi dan menghargai pendapat orang lain",
            "TP 3. Menunjukkan minat untuk mengenal dan berbagi pengalaman dengan orang lain (termasuk pengalaman budaya)",
            "TP 4. Memahami, menanggapi, dan mengelola emosi orang lain (empati)",
            "TP 5. Mengenal, mengatur, dan mengendalikan emosi sendiri"
          ]
        }
      },
      {
        elemen: "Literasi, Matematika, Sains, Teknologi, Rekayasa & Seni",
        fase: ["Usia 4-5 Tahun", "Usia 5-6 Tahun"],
        sub: {
          "Usia 4-5 Tahun": [
            "KELOMPOK 1: Murid menunjukkan ketertarikan dan berpartisipasi dalam kegiatan pra-literasi",
            "TP 1. Mengenal dan menceritakan kembali cerita sederhana",
            "TP 2. Mengenal simbol dan huruf awal namanya",
            "TP 3. Membaca nyaring dan menulis permulaan dengan bimbingan (misal: menebalkan, menjiplak)",
            "TP 4. Menggunakan bahasa verbal (lisan) dan non-verbal (gerak tubuh) untuk berkomunikasi",
            "TP 5. Mengenal bentuk-bentuk huruf dan angka",
            "---",
            "KELOMPOK 2: Murid menunjukkan ketertarikan pada konsep pra-matematika dan sains",
            "TP 1. Mengenal konsep bilangan (1-10) dan berhitung sederhana",
            "TP 2. Mengenal dan membedakan bentuk, ukuran, dan warna",
            "TP 3. Mengamati dan mendiskusikan fenomena alam/sekitar yang sederhana",
            "TP 4. Melakukan percobaan sederhana dengan bimbingan (misal: mencampur warna)",
            "TP 5. Mengenal dan menggunakan teknologi (komputer/tablet/proyektor) untuk pembelajaran dengan bimbingan",
            "---",
            "KELOMPOK 3: Murid menunjukkan ketertarikan pada gerak dan seni",
            "TP 1. Melakukan gerakan motorik kasar/halus yang terkontrol (contoh: melempar dan menangkap bola dengan akurasi)",
            "TP 2. Menggunakan alat tulis/gunting/kuas dengan kontrol yang baik",
            "TP 3. Menggunting/menempel/melipat sesuai pola yang kompleks",
            "TP 4. Membuat karya seni (gambar, lukisan, patung, kolase) sesuai ide sendiri",
            "TP 5. Bernyanyi, menari, dan memainkan alat musik sederhana sesuai irama",
            "TP 6. Mengapresiasi dan menanggapi karya seni (memberi kritik dan saran sederhana)"
          ],
          "Usia 5-6 Tahun": [
            "KELOMPOK 1: Murid menunjukkan ketertarikan dan berpartisipasi dalam kegiatan pra-literasi",
            "TP 1. Mengenal dan menceritakan kembali cerita yang lebih kompleks (memahami alur)",
            "TP 2. Mengenal simbol huruf A-Z, menulis nama sendiri tanpa dicontoh, dan menulis kata sederhana",
            "TP 3. Membaca nyaring dan menulis permulaan secara mandiri (misal: meniru tulisan)",
            "TP 4. Menggunakan bahasa verbal (lisan) dan non-verbal (gerak tubuh) untuk berkomunikasi dan menceritakan ide",
            "TP 5. Mengenal bentuk-bentuk huruf, angka, dan lambang bilangan (1-20)",
            "TP 6. Menggunakan perbendaharaan kata yang lebih luas (kata sifat/kerja)",
            "---",
            "KELOMPOK 2: Murid menunjukkan ketertarikan pada konsep pra-matematika dan sains",
            "TP 1. Mengenal konsep bilangan (1-20), berhitung sederhana, dan mengurutkan bilangan",
            "TP 2. Mengenal dan membedakan bentuk, ukuran, dan warna, serta mengelompokkan benda berdasarkan kriteria tertentu",
            "TP 3. Mengamati dan mendiskusikan fenomena alam/sekitar yang lebih kompleks dan mencari tahu sebab-akibat",
            "TP 4. Melakukan percobaan sederhana secara mandiri dan menarik kesimpulan",
            "TP 5. Mengenal dan menggunakan teknologi (komputer/tablet/proyektor) untuk pembelajaran dengan bimbingan",
            "---",
            "KELOMPOK 3: Murid menunjukkan ketertarikan pada gerak dan seni",
            "TP 1. Melakukan gerakan motorik kasar/halus yang terkontrol dan kompleks (contoh: melompat dengan dua kaki, menyeimbangkan)",
            "TP 2. Menggunakan alat tulis/gunting/kuas dengan kontrol yang baik dan presisi",
            "TP 3. Menggunting/menempel/melipat sesuai pola yang kompleks",
            "TP 4. Membuat karya seni (gambar, lukisan, patung, kolase) sesuai ide sendiri dan menceritakan karyanya",
            "TP 5. Bernyanyi, menari, dan memainkan alat musik sederhana sesuai irama",
            "TP 6. Mengapresiasi dan menanggapi karya seni (memberi kritik dan saran sederhana)"
          ]
        }
      },
      // START: PENAMBAHAN MUATAN LOKAL BERDASARKAN FILE DOKUMEN
      {
        elemen: "Muatan Lokal (PAI dan Life Skill)",
        fase: ["Muatan Lokal"],
        sub: {
          "Muatan Lokal": [
            "I. Aqidah",
            "1. Mengenal Syahadat",
            "2. Mengenal Allah dan Ciptaannya",
            "3. Mengenal Nabi Muhammad SAW",
            "4. Mengenal beberapa Agama",
            "5. Mengenal rukun Islam",
            "6. Mengenal rukun iman",
            "---",
            "II. Akhlak",
            "1. Tertib dan patuh pada peraturan",
            "2. Rapi dalam berpakaian",
            "3. Mengenal milik sendiri dan milik orang lain",
            "4. Menyayangi teman",
            "5. Berani meminta maaf dan memberi maaf",
            "6. Dapat membedakan perbuatan baik dan buruk",
            "7. Menghargai orang yang sedang berbicara",
            "8. Bersikap ramah",
            "9. Mau berbagi, menolong, dan membantu teman",
            "10. Berbagi mainan dan benda milik sendiri",
            "11. Menghargai orang lain",
            "---",
            "III. Ibadah",
            "1. Doa-doa harian",
            "2. Hafalan surat pendek (minimal 3 surat)",
            "3. Hafalan hadits (minimal 3 hadits)",
            "4. Praktik Sholat",
            "---",
            "IV. Al-Qur'an",
            "1. Membaca huruf hijaiyah",
            "2. Mengenal harokat dan tanda baca",
            "3. Mengenal Juz Amma",
            "4. Dapat mengikuti bacaan guru/menirukan"
          ]
        }
      },
      // END: PENAMBAHAN MUATAN LOKAL BERDASARKAN FILE DOKUMEN
      // START: PENAMBAHAN KOKUR (P5) BERDASARKAN FILE DOKUMEN
      {
        elemen: "KoKur (P5) - Projek Penguatan Profil Pelajar Pancasila",
        fase: ["KoKur"],
        sub: {
          "KoKur": [
            "PROFIL 1: Beriman, Bertakwa kepada Tuhan YME, dan Berakhlak Mulia",
            "1. Melaksanakan kewajiban beribadah",
            "2. Mengenal dan mencintai sesama makhluk hidup",
            "3. Mengenal dan menjaga lingkungan sekitar",
            "---",
            "PROFIL 2: Mandiri",
            "1. Mengenal kemampuan diri",
            "2. Memahami kelemahan dan kelebihan diri",
            "3. Bersikap gigih dan tidak mudah menyerah",
            "---",
            "PROFIL 3: Bergotong Royong",
            "1. Mengenal arti bekerja sama",
            "2. Berbagi peran/tugas dengan teman",
            "3. Saling tolong menolong",
            "---",
            "PROFIL 4: Berkebinekaan Global",
            "1. Mengenal dan menghargai keragaman suku, agama, ras, dan budaya",
            "2. Mengenal keunikan budaya daerah",
            "3. Menghargai perbedaan",
            "---",
            "PROFIL 5: Bernalar Kritis",
            "1. Berani bertanya dan mengeluarkan pendapat",
            "2. Menyampaikan hasil pemikiran kepada orang lain",
            "3. Mampu memecahkan masalah sederhana",
            "---",
            "PROFIL 6: Kreatif",
            "1. Menghasilkan ide/karya baru yang orisinal",
            "2. Mengembangkan ide dari ide orang lain",
            "3. Mencoba berbagai cara dalam menghasilkan karya"
          ]
        }
      }
      // END: PENAMBAHAN KOKUR (P5) BERDASARKAN FILE DOKUMEN
    ];

    const PHOTO_AREAS = [
      { id: 'fotoGridAgama', key: 'agama', nama: 'Nilai Agama' },
      { id: 'fotoGridJatidiri', key: 'jati', nama: 'Jati Diri' },
      { id: 'fotoGridLiterasi', key: 'literasi', nama: 'Literasi' },
      { id: 'fotoGridKokur', key: 'kokur', nama: 'Ko Kurikuler' },
      { id: 'fotoGridMulok', key: 'mulok', nama: 'Muatan Lokal' },
    ];

    /* =========================== DATA & PERSISTENCE =========================== */

    let siswaData = JSON.parse(localStorage.getItem('siswaData')) || [];
    let atpData = JSON.parse(localStorage.getItem('atpData')) || {};
    let pengaturan = JSON.parse(localStorage.getItem('pengaturan')) || {};
    let photosData = JSON.parse(localStorage.getItem('photosData')) || {};
    
    function sinkronisasiMulok(nisn) {
    const mulok = MASTER_ATP.find(m => m.elemen.includes('Muatan Lokal'));
    if (!mulok) return;
    const fase = "Muatan Lokal";
    const hasil = [];
    const dataATP = atpData[nisn] && atpData[nisn][mulok.elemen] && atpData[nisn][mulok.elemen].scores
        ? atpData[nisn][mulok.elemen].scores
        : {};
    let index = 0;
    mulok.sub[fase].forEach(sub => {
        if (
        !sub.startsWith('---') &&
        !sub.startsWith('I.') &&
        !sub.startsWith('II.') &&
        !sub.startsWith('III.') &&
        !sub.startsWith('IV.') &&
        !sub.startsWith('PROFIL') &&
        !sub.startsWith('KELOMPOK') &&
        sub.trim() !== ''
        ) {
        const tpKey = `${mulok.elemen}_${fase}_${index}`;
        hasil.push({
            text: sub,
            score: dataATP[tpKey] || '4'
        });
        }
        index++;
    });
    atpData[nisn] = atpData[nisn] || {};
    atpData[nisn].MuLok = hasil;
    saveData();
    }

    // =================================== 
    // KODE HILANG / PLACEHOLDER (DIISI ULANG UNTUK FUNGSI)
    // =================================== 

    // --- HELPER FUNCTIONS ---
    function saveData() {
        localStorage.setItem('siswaData', JSON.stringify(siswaData));
        localStorage.setItem('atpData', JSON.stringify(atpData));
        localStorage.setItem('pengaturan', JSON.stringify(pengaturan));
        localStorage.setItem('photosData', JSON.stringify(photosData));
        showToast('Data berhasil disimpan!');
    }

    function loadData() {
        siswaData = JSON.parse(localStorage.getItem('siswaData')) || [];
        atpData = JSON.parse(localStorage.getItem('atpData')) || {};
        pengaturan = JSON.parse(localStorage.getItem('pengaturan')) || {};
        photosData = JSON.parse(localStorage.getItem('photosData')) || {};
    }

    function findSiswa(nisn) {
        return siswaData.find(s => s.nisn === nisn);
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // --- AUTH/LOCK FUNCTIONS ---
    const AUTH_USER = { username: 'guru', password: 'password' }; // Default

    function applyLockState(isLocked) {
        if (isLocked) {
            document.body.classList.add('grayscale-mode');
            document.getElementById('userBadge').innerHTML = 'üîí <span id="userName">Terkunci</span>';
            document.getElementById('loginKeyIcon').textContent = 'üîí';
        } else {
            document.body.classList.remove('grayscale-mode');
            document.getElementById('userBadge').innerHTML = '‚úÖ <span id="userName">Guru (Developer)</span>';
            document.getElementById('loginKeyIcon').textContent = 'üîì';
        }
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('loginPassword');
        const toggleIcon = document.getElementById('togglePassword');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.textContent = 'üôà';
        } else {
            passwordInput.type = 'password';
            toggleIcon.textContent = 'üëÅÔ∏è';
        }
    }

    function toggleLoginForm() {
        document.getElementById('loginForm').classList.toggle('hidden');
    }

    function handleLogin() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        if (username === AUTH_USER.username && password === AUTH_USER.password) {
            applyLockState(false);
            document.getElementById('loginForm').classList.add('hidden');
            showToast('Login Berhasil!');
        } else {
            showToast('Username atau Password salah!');
        }
    }

    function resetPassword(event) {
        event.preventDefault();
        AUTH_USER.password = 'password'; // Reset ke default
        showToast('Password di-reset ke "password". Silakan login ulang.');
        applyLockState(true);
        document.getElementById('loginForm').classList.remove('hidden');
    }

    // --- PENGATURAN FUNCTIONS ---
    function simpanPengaturan() {
        const logoInput = document.getElementById('logoInput');
        const newPengaturan = {
            namaSekolah: document.getElementById('namaSekolah').value,
            namaYayasan: document.getElementById('namaYayasan').value,
            alamatSekolah: document.getElementById('alamatSekolah').value,
            kontakSekolah: document.getElementById('kontakSekolah').value,
            kepalaSekolah: document.getElementById('kepalaSekolah').value,
            nipKepsek: document.getElementById('nipKepsek').value,
            guruKelas: document.getElementById('guruKelas').value,
            nipGuru: document.getElementById('nipGuru').value,
            tahunAjaran: document.getElementById('tahunAjaran').value,
            semester: document.getElementById('semester').value,
            tanggalRapor: document.getElementById('tanggalRapor').value,
            logoDataURL: pengaturan.logoDataURL || '' 
        };

        if (logoInput.files && logoInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                newPengaturan.logoDataURL = e.target.result;
                pengaturan = newPengaturan;
                saveData();
                applyPengaturanToUI();
            };
            reader.readAsDataURL(logoInput.files[0]);
        } else {
            pengaturan = newPengaturan;
            saveData();
            applyPengaturanToUI();
        }
    }

    function applyPengaturanToUI() {
        const peng = pengaturan;
        document.getElementById('namaSekolah').value = peng.namaSekolah || '';
        document.getElementById('namaYayasan').value = peng.namaYayasan || '';
        document.getElementById('alamatSekolah').value = peng.alamatSekolah || '';
        document.getElementById('kontakSekolah').value = peng.kontakSekolah || '';
        document.getElementById('kepalaSekolah').value = peng.kepalaSekolah || '';
        document.getElementById('nipKepsek').value = peng.nipKepsek || '';
        document.getElementById('guruKelas').value = peng.guruKelas || '';
        document.getElementById('nipGuru').value = peng.nipGuru || '';
        document.getElementById('tahunAjaran').value = peng.tahunAjaran || '';
        document.getElementById('semester').value = peng.semester || '';
        document.getElementById('tanggalRapor').value = peng.tanggalRapor || '';

        // Tampilkan logo di preview dan dashboard
        const logoPreview = document.getElementById('logoPreview');
        const logoDashboard = document.getElementById('logoDashboard');
        if (peng.logoDataURL) {
            logoPreview.src = peng.logoDataURL;
            logoDashboard.src = peng.logoDataURL;
            logoPreview.style.display = 'block';
            logoDashboard.style.display = 'block';
        } else {
            logoPreview.style.display = 'none';
            logoDashboard.style.display = 'none';
        }
        // Update judul header
        document.querySelector('header').textContent = `e-Raport Deep Learning TK ‚Äî ${peng.namaSekolah || 'Deep Learning'}`;
    }

    function renderTimPengembang() {
        // Hardcoded, tidak perlu diubah kecuali ada permintaan khusus
    }

    // --- NAVIGATION/UI FUNCTIONS ---
    let currentNisn = '';

    function showSection(id) {
        document.querySelectorAll('section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(id).style.display = 'block';

        // Panggil fungsi refresh yang spesifik saat pindah section
        if (id === 'alurTujuan' || id === 'intraKurikuler' || id === 'koKurikuler' || id === 'muatanLokal' || id === 'raport') {
            fillSiswaSelects(id);
        }
    }

    function fillSiswaSelects(sectionId) {
        const selects = ['pilihSiswaATP', 'pilihSiswaCetak'];
        
        // Cek jika section saat ini adalah Intra, KoKur, atau MuLok untuk update currentNisn
        if (['intraKurikuler', 'koKurikuler', 'muatanLokal'].includes(sectionId)) {
            // Gunakan NISN yang sudah disimpan atau ambil NISN siswa pertama jika belum ada
            if (!currentNisn && siswaData.length > 0) {
                currentNisn = siswaData[0].nisn;
            }
        }
        
        // Handle select ATP and Cetak
        selects.forEach(id => {
            const select = document.getElementById(id);
            const selectedNisn = select.value;
            select.innerHTML = '<option value="">-- pilih siswa --</option>';
            siswaData.forEach(s => {
                const option = document.createElement('option');
                option.value = s.nisn;
                option.textContent = `${s.nama} (${s.kelas})`;
                select.appendChild(option);
            });
            // Pertahankan siswa yang dipilih jika ada
            if (siswaData.some(s => s.nisn === selectedNisn)) {
                select.value = selectedNisn;
            } else if (id === 'pilihSiswaATP' && siswaData.length > 0) {
                 // Set default siswa pertama untuk ATP jika belum ada yang terpilih
                 // Tidak perlu, biarkan user memilih
            }
        });

        // Set currentNisn untuk Intra/KoKur/MuLok jika sudah ada siswa terpilih di salah satu select
        if (document.getElementById('pilihSiswaATP').value) {
            currentNisn = document.getElementById('pilihSiswaATP').value;
        }

        if (currentNisn) {
            updateSectionDetails(currentNisn, sectionId);
        } else if (sectionId === 'intraKurikuler') {
             document.getElementById('intraNama').textContent = '-';
        } else if (sectionId === 'koKurikuler') {
             document.getElementById('kokurNama').textContent = '-';
        } else if (sectionId === 'muatanLokal') {
             document.getElementById('mulokNama').textContent = '-';
        }
    }

    function updateSectionDetails(nisn, sectionId) {
        if (!nisn) return;
        const siswa = findSiswa(nisn);
        const name = siswa ? `${siswa.nama} (${siswa.kelas})` : '-';

        if (sectionId === 'intraKurikuler') {
            document.getElementById('intraNama').textContent = name;
            // Load intra data
            const sum = atpData[nisn]?.intraSummary || {};
            document.getElementById('deskAgama').value = sum.agama || '';
            document.getElementById('deskJatidiri').value = sum.jatidiri || '';
            document.getElementById('deskLiterasi').value = sum.literasi || '';
            document.getElementById('catatanOrtu').value = sum.catatanOrtu || '';
            
            // Render photos for each element
            PHOTO_AREAS.filter(p => p.key === 'agama' || p.key === 'jati' || p.key === 'literasi').forEach(area => renderPhotos(nisn, area.key, area.id));

        } else if (sectionId === 'koKurikuler') {
            document.getElementById('kokurNama').textContent = name;
            // Load kokur data
            const sum = atpData[nisn]?.kokurSummary || {};
            document.getElementById('deskKokur').value = sum.deskripsi || '';
            document.getElementById('catatanGuru').value = sum.catatanGuru || '';
            renderPhotos(nisn, 'kokur', 'fotoGridKokur');

        } else if (sectionId === 'muatanLokal') {
            document.getElementById('mulokNama').textContent = name;
            // Load mulok data
            const sum = atpData[nisn]?.mulokSummary || {};
            document.getElementById('deskMulok').value = sum.deskripsi || '';
            document.getElementById('catatanGuruMulok').value = sum.catatanGuru || '';
            renderPhotos(nisn, 'mulok', 'fotoGridMulok');
        }
    }


    // --- DATA SISWA FUNCTIONS ---

    function importSiswa() {
        const input = document.getElementById('inputSiswa').value.trim();
        if (!input) {
            showToast('Tempel data Excel terlebih dahulu.');
            return;
        }

        const lines = input.split('\n').filter(line => line.trim() !== '');
        let importedCount = 0;
        let nisnCount = 0;

        lines.forEach(line => {
            const parts = line.split('\t').map(p => p.trim());
            const [nama, nisn, kelas] = parts;
            
            if (nama && kelas) {
                 // Gunakan NISN dari input atau buat NISN acak jika kosong
                const finalNisn = nisn || `TK-${Math.floor(Math.random() * 90000) + 10000}`; 

                // Cek duplikasi NISN
                if (siswaData.some(s => s.nisn === finalNisn)) {
                    nisnCount++; // Hanya hitung NISN duplikat yang diinput
                    return; 
                }

                siswaData.push({
                    nama,
                    nisn: finalNisn,
                    kelas,
                    prestasi: '', // Tambah kolom prestasi
                    presensi: { sakit: 0, izin: 0, alpha: 0 }
                });
                importedCount++;
            }
        });

        if (nisnCount > 0) {
            showToast(`Import selesai. ${importedCount} siswa ditambahkan. ${nisnCount} siswa gagal (NISN duplikat atau data tidak lengkap).`);
        } else {
            showToast(`Import selesai. ${importedCount} siswa berhasil ditambahkan.`);
        }
        
        saveData();
        tampilkanSiswa();
        fillSiswaSelects();
    }
    
    function tambahManual() {
        const nama = document.getElementById('namaManual').value.trim();
        const nisn = document.getElementById('nisnManual').value.trim() || `TK-${Math.floor(Math.random() * 90000) + 10000}`;
        const kelas = document.getElementById('kelasManual').value.trim();

        if (!nama || !kelas) {
            showToast('Nama dan Kelas wajib diisi.');
            return;
        }
        if (siswaData.some(s => s.nisn === nisn)) {
            showToast('NISN sudah ada. Gunakan NISN lain.');
            return;
        }

        siswaData.push({
            nama,
            nisn,
            kelas,
            prestasi: '',
            presensi: { sakit: 0, izin: 0, alpha: 0 }
        });

        document.getElementById('namaManual').value = '';
        document.getElementById('nisnManual').value = '';
        document.getElementById('kelasManual').value = '';
        
        saveData();
        tampilkanSiswa();
        fillSiswaSelects();
        showToast('Siswa berhasil ditambahkan.');
    }

    function hapusSiswa(nisn) {
        if (confirm(`Yakin ingin menghapus siswa dengan NISN: ${nisn}? Data penilaian akan ikut terhapus.`)) {
            siswaData = siswaData.filter(s => s.nisn !== nisn);
            delete atpData[nisn]; // Hapus data penilaian
            delete photosData[nisn]; // Hapus foto
            saveData();
            tampilkanSiswa();
            fillSiswaSelects();
            showToast('Siswa berhasil dihapus.');
        }
    }

    function updatePresensi(nisn, key, value) {
        const siswa = findSiswa(nisn);
        if (siswa) {
            siswa.presensi[key] = parseInt(value) || 0;
            saveData();
            // Tidak perlu tampilkanSiswa, karena sudah disimpan otomatis
        }
    }

    function updateSiswaDetail(nisn, key, value) {
        const siswa = findSiswa(nisn);
        if (siswa) {
            siswa[key] = value.trim();
            saveData();
            // Tidak perlu tampilkanSiswa, karena sudah disimpan otomatis
        }
    }

    function tampilkanSiswa() {
        if (siswaData.length === 0) {
            document.getElementById('tabelSiswa').innerHTML = '<p class="muted">Belum ada data siswa.</p>';
            return;
        }

        const tableBody = siswaData.map((s, index) => `
            <tr>
                <td style="text-align:top">${index + 1}</td>
                <td>${s.nama}</td>
                <td>${s.nisn}</td>
                <td>${s.kelas}</td>
                <td><textarea onchange="updateSiswaDetail('${s.nisn}', 'prestasi', this.value)" rows="3" placeholder="Contoh: Juara 1 lomba mewarnai">${s.prestasi}</textarea></td>
                <td><input type="number" style="width:50px" value="${s.presensi.sakit}" onchange="updatePresensi('${s.nisn}', 'sakit', this.value)"></td>
                <td><input type="number" style="width:50px" value="${s.presensi.izin}" onchange="updatePresensi('${s.nisn}', 'izin', this.value)"></td>
                <td><input type="number" style="width:50px" value="${s.presensi.alpha}" onchange="updatePresensi('${s.nisn}', 'alpha', this.value)"></td>
                <td><button onclick="hapusSiswa('${s.nisn}')" class="btn" style="background:red">‚ùå</button></td>
            </tr>
        `).join('');

        const tableHtml = `
            <table border="1">
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 30px;">No</th>
                        <th rowspan="2">Nama</th>
                        <th rowspan="2">NISN</th>
                        <th rowspan="2">Kelas</th>
                        <th rowspan="2">Prestasi</th>
                        <th colspan="3" style="text-align: center;">Presensi (Hari)</th>
                        <th rowspan="2" style="width: 50px;">Aksi</th>
                    </tr>
                    <tr>
                        <th style="width: 50px;">Sakit</th>
                        <th style="width: 50px;">Izin</th>
                        <th style="width: 50px;">Alpha</th>
                    </tr>
                </thead>
                <tbody>${tableBody}</tbody>
            </table>
        `;
        document.getElementById('tabelSiswa').innerHTML = siswaData.length > 0 ? tableHtml : '<p class="muted">Belum ada data siswa.</p>';
    }

    // --- ATP FUNCTIONS ---

    function onJenisChangeATP() {
        const jenis = document.getElementById('jenisATP').value;
        const selectElemen = document.getElementById('selectElemen');
        selectElemen.innerHTML = `<option value="">-- pilih elemen --</option>`;

        // Filter elemen berdasarkan jenis
        const filteredMaster = MASTER_ATP.filter(m => {
            if (jenis === 'Intra') {
                return m.elemen !== 'KoKur (P5) - Projek Penguatan Profil Pelajar Pancasila' && !m.elemen.includes('Muatan Lokal');
            } else if (jenis === 'KoKur') {
                return m.elemen === 'KoKur (P5) - Projek Penguatan Profil Pelajar Pancasila';
            } else if (jenis === 'MuLok') {
                return m.elemen.includes('Muatan Lokal');
            }
            return false;
        });

        filteredMaster.forEach(m => {
            const option = document.createElement('option');
            option.value = m.elemen;
            option.textContent = m.elemen;
            selectElemen.appendChild(option);
        });

        // Reset fase
        document.getElementById('selectFase').innerHTML = `<option value="">-- pilih fase --</option>`;
        onElemenChange(); // Trigger the next level
    }

    function onSiswaChangeATP() {
        const nisn = document.getElementById('pilihSiswaATP').value;
        const siswa = findSiswa(nisn);
        document.getElementById('kelasATP').value = siswa ? siswa.kelas : '';
        currentNisn = nisn;
        
        // Reset elemen dan fase, lalu panggil onJenisChangeATP untuk merender elemen yang benar
        document.getElementById('selectElemen').innerHTML = `<option value="">-- pilih elemen --</option>`;
        document.getElementById('selectFase').innerHTML = `<option value="">-- pilih fase --</option>`;
        onJenisChangeATP(); 
        
        onFaseChange(); // Trigger the TP list load
    }


    function onElemenChange() {
        const elemen = document.getElementById('selectElemen').value;
        const nisn = document.getElementById('pilihSiswaATP').value;
        const siswa = findSiswa(nisn);
        const kelas = siswa ? siswa.kelas : '';
        const selectFase = document.getElementById('selectFase');
        selectFase.innerHTML = `<option value="">-- pilih fase --</option>`;

        const master = MASTER_ATP.find(m => m.elemen === elemen);
        if (master) {
            master.fase.forEach(f => {
                const option = document.createElement('option');
                option.value = f;
                option.textContent = f;
                selectFase.appendChild(option);
            });
            
            // Auto-select fase berdasarkan kelas
            if (siswa) {
                 const defaultFase = master.fase.find(f => f.includes(kelas) || f.includes('KoKur') || f.includes('Muatan Lokal'));
                 selectFase.value = defaultFase || '';
            }
        }
        onFaseChange(); // Trigger the TP list load
    }

    function onFaseChange() {
        const nisn = document.getElementById('pilihSiswaATP').value;
        const elemen = document.getElementById('selectElemen').value;
        const fase = document.getElementById('selectFase').value;
        const jenis = document.getElementById('jenisATP').value;
        const container = document.getElementById('daftarTujuanPembelajaran');
        container.innerHTML = '';
        document.getElementById('judulDaftarTP').style.display = 'none';

        if (!nisn || !elemen || !fase) {
            container.innerHTML = `<div class="muted">Lengkapi pilihan Siswa, Elemen, dan Fase untuk menampilkan daftar Tujuan Pembelajaran.</div>`;
            return;
        }

        const master = MASTER_ATP.find(m => m.elemen === elemen);
        const tps = master ? master.sub[fase] || [] : [];
        
        // Pastikan data penilaian untuk siswa tersebut sudah diinisiasi
        atpData[nisn] = atpData[nisn] || {};
        atpData[nisn][elemen] = atpData[nisn][elemen] || {};
        const penilaianSaatIni = atpData[nisn][elemen].scores || {};
        
        if (tps.length === 0) {
             container.innerHTML = `<div class="muted">Tidak ada Tujuan Pembelajaran yang ditemukan untuk kombinasi ini.</div>`;
             return;
        }
        
        document.getElementById('judulDaftarTP').style.display = 'block';

        let html = '';
        tps.forEach((tp, index) => {
            const isHeader = tp.startsWith('KELOMPOK') || tp.startsWith('PROFIL') || tp.startsWith('I.') || tp.startsWith('---');
            const tpKey = `${elemen}_${fase}_${index}`;
            const currentScore = penilaianSaatIni[tpKey] || '4'; // Default ke BSB (Berkembang Sangat Baik)

            if (tp.startsWith('---')) {
                html += '<hr style="margin: 10px 0; border: none; border-top: 1px dashed #cfe9ff;">';
            } else if (isHeader) {
                html += `<div style="font-weight: bold; margin-top: 10px; padding: 4px 0; border-bottom: 1px solid #c6e5ff; font-size: 14px; color:#0056b3;">${tp}</div>`;
            } else {
                html += `
                    <div class="tp-row">
                        <div class="tp-text">${tp}</div>
                        <select class="penilaian-select" id="score_${tpKey}">
                            <option value="4" ${currentScore === '4' ? 'selected' : ''}>BSB (Berkembang Sangat Baik)</option>
                            <option value="3" ${currentScore === '3' ? 'selected' : ''}>BSH (Baik)</option>
                            <option value="2" ${currentScore === '2' ? 'selected' : ''}>MB (Mulai Berkembang)</option>
                            <option value="1" ${currentScore === '1' ? 'selected' : ''}>BB (Belum Berkembang)</option>
                        </select>
                    </div>
                `;
            }
        });

        container.innerHTML = html;
    }

    function simpanATP() {
    const nisn = document.getElementById('pilihSiswaATP').value;
    const elemen = document.getElementById('selectElemen').value;
    const fase = document.getElementById('selectFase').value;
    const jenis = document.getElementById('jenisATP').value;

    if (!nisn || !elemen || !fase) {
        showToast('Pilih Siswa, Elemen, dan Fase terlebih dahulu.');
        return;
    }

    const master = MASTER_ATP.find(m => m.elemen === elemen);
    const tps = master ? master.sub[fase] || [] : [];
    const newScores = {};

    tps.forEach((tp, index) => {
        const tpKey = `${elemen}_${fase}_${index}`;
        const select = document.getElementById(`score_${tpKey}`);
        if (select) {
        newScores[tpKey] = select.value;
        }
    });

    // Generate deskripsi baru
    const newDeskripsi = generateDeskripsi(nisn, elemen, fase, newScores);

    // Simpan data
    atpData[nisn] = atpData[nisn] || {};
    atpData[nisn][elemen] = {
        scores: newScores,
        deskripsiOtomatis: newDeskripsi
    };

    if (jenis === 'Intra') {
        atpData[nisn].intraSummary = atpData[nisn].intraSummary || {};
        if (elemen.includes('Agama')) atpData[nisn].intraSummary.agama = newDeskripsi;
        if (elemen.includes('Jati Diri')) atpData[nisn].intraSummary.jatidiri = newDeskripsi;
        if (elemen.includes('Literasi')) atpData[nisn].intraSummary.literasi = newDeskripsi;
    } else if (jenis === 'KoKur') {
        atpData[nisn].kokurSummary = atpData[nisn].kokurSummary || {};
        atpData[nisn].kokurSummary.deskripsi = newDeskripsi;
    } else if (jenis === 'MuLok') {
        atpData[nisn].mulokSummary = atpData[nisn].mulokSummary || {};
        atpData[nisn].mulokSummary.deskripsi = newDeskripsi;
        sinkronisasiMulok(nisn); // PANGGIL SINKRONISASI DI SINI
    }
    saveData();
    showToast('Penilaian dan deskripsi otomatis berhasil disimpan!');
    }

        const elemen = document.getElementById('selectElemen').value;
        const nisn = document.getElementById('pilihSiswaATP').value;
        const fase = document.getElementById('selectFase').value;
        const jenis = document.getElementById('jenisATP').value;
        const master = MASTER_ATP.find(m => m.elemen === elemen);
        const tps = master ? master.sub[fase] || [] : [];
        const newScores = {};

        tps.forEach((tp, index) => {
            const tpKey = `${elemen}_${fase}_${index}`;
            const select = document.getElementById(`score_${tpKey}`);
            if (select) {
                newScores[tpKey] = select.value;
            }
        });
        
        // Generate deskripsi baru
        const newDeskripsi = generateDeskripsi(nisn, elemen, fase, newScores);

        // Simpan data
        atpData[nisn] = atpData[nisn] || {};
        atpData[nisn][elemen] = {
            scores: newScores,
            deskripsiOtomatis: newDeskripsi
        };

        // Update Summary (untuk Intra)
        if (jenis === 'Intra') {
            atpData[nisn].intraSummary = atpData[nisn].intraSummary || {};
            if (elemen.includes('Agama')) atpData[nisn].intraSummary.agama = newDeskripsi;
            if (elemen.includes('Jati Diri')) atpData[nisn].intraSummary.jatidiri = newDeskripsi;
            if (elemen.includes('Literasi')) atpData[nisn].intraSummary.literasi = newDeskripsi;
        } 
        // Update Summary (untuk KoKur)
        else if (jenis === 'KoKur') {
            atpData[nisn].kokurSummary = atpData[nisn].kokurSummary || {};
            atpData[nisn].kokurSummary.deskripsi = newDeskripsi;
        }
        // Update Summary (untuk MuLok)
        else if (jenis === 'MuLok') {
            atpData[nisn].mulokSummary = atpData[nisn].mulokSummary || {};
            atpData[nisn].mulokSummary.deskripsi = newDeskripsi;
            // Simpan skor MuLok untuk tabel rubrik
            atpData[nisn].MuLok = tps.filter((tp, index) => !tp.startsWith('---') && !tp.includes('KELOMPOK') && !tp.includes('PROFIL') && !tp.includes('.')).map((tp, index) => ({
                 text: tp,
                 score: newScores[`${elemen}_${fase}_${tps.indexOf(tp)}`] || '4'
            }));
        }

        saveData();
        showToast('Penilaian dan deskripsi otomatis berhasil disimpan!');
    

    function generateDeskripsi(nisn, elemen, fase, scores) {
        const siswa = findSiswa(nisn);
        const namaPanggilan = siswa.nama.split(' ')[0];
        
        const master = MASTER_ATP.find(m => m.elemen === elemen);
        const tps = master ? master.sub[fase] || [] : [];
        
        // Group TP's by score
        const finalScores = {
            '4': [], // BSB (Berkembang Sangat Baik)
            '3': [], // BSH (Berkembang Sesuai Harapan / Baik)
            '2': [], // MB (Mulai Berkembang)
            '1': []  // BB (Belum Berkembang)
        };

        tps.forEach((tp, index) => {
            const tpKey = `${elemen}_${fase}_${index}`;
            const score = scores[tpKey];
            if (score && score !== '4' && !tp.startsWith('KELOMPOK') && !tp.startsWith('PROFIL') && !tp.startsWith('I.') && !tp.startsWith('---')) {
                finalScores[score].push({ text: tp, score: parseInt(score) });
            }
             if (score && score === '4' && !tp.startsWith('KELOMPOK') && !tp.startsWith('PROFIL') && !tp.startsWith('I.') && !tp.startsWith('---')) {
                finalScores['4'].push({ text: tp, score: parseInt(score) });
            }
        });
        
        let descriptor = `Ananda **${namaPanggilan}** telah menunjukkan kemajuan yang sangat baik di elemen **${elemen}** ini. `;
        
        // Capaian Tertinggi (BSH dan BSB)
        const highestCapaian = finalScores['4'].concat(finalScores['3']).sort(() => 0.5 - Math.random());
        if (highestCapaian.length > 0) {
             const tps = highestCapaian.map(item => item.text.replace(/^(TP|Tp)\s*\d+\.\s*/, '').replace(/^[IVX]+\.\s*/, '').replace(/^[A-G]+\.\s*/, '').trim());
             const tpsText = tps.length > 3 ? tps.slice(0, 3).join(', ') + `, dan ${tps.length - 3} tujuan lain` : tps.join(', ');
             descriptor += `Beberapa capaian yang menonjol adalah kemampuan **${tpsText}**. `;
        }


        // Area yang Perlu Penguatan (MB: 2 atau BB: 1)
        const needsImprovement = [...finalScores['1'], ...finalScores['2']].sort((a, b) => a.score - b.score);
        if (needsImprovement.length > 0) {
            const tps = needsImprovement.map(item => item.text.replace(/^(TP|Tp)\s*\d+\.\s*/, '').replace(/^[IVX]+\.\s*/, '').replace(/^[A-G]+\.\s*/, '').trim());
            const tpsText = tps.length > 3 ? tps.slice(0, 3).join(', ') + `, dan ${tps.length - 3} tujuan lain` : tps.join(', ');
            descriptor += `**${namaPanggilan} disarankan untuk lebih didampingi** dan diberikan penguatan dalam hal: ${tpsText}.`;
        }

        return descriptor.trim();
    }


    /* =========================== MODIFIKASI: Rubrik Muatan Lokal (FIXED DOUBLE STYLE) =========================== */
    function getMulokRubricTable(muLokScores) {
        const masterMulok = MASTER_ATP.find(m => m.elemen.includes('Muatan Lokal'));
        if (!masterMulok) return '<p style="font-style: italic; color: #666; text-align: center; margin-top: 15px;">Definisi Muatan Lokal tidak ditemukan di MASTER_ATP.</p>';

        const cellStyle = 'padding: 5px 10px; border: 1px solid black; font-size: 13px; text-align: left;';
        const cellCenterStyle = 'padding: 5px 10px; border: 1px solid black; font-size: 13px; text-align: center;';

        const headerHtml = `
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th rowspan="2" style="width: 30px; ${cellCenterStyle}">No</th>
                    <th rowspan="2" style="${cellStyle}">Capaian Kompetensi Muatan Lokal</th>
                    <th colspan="4" style="text-align: center; ${cellCenterStyle}">Penilaian</th>
                </tr>
                <tr style="background-color: #f2f2f2;">
                    <th style="width: 50px; ${cellCenterStyle}">BSB</th>
                    <th style="width: 50px; ${cellCenterStyle}">MB</th>
                    <th style="width: 50px; ${cellCenterStyle}">BSH</th>
                    <th style="width: 50px; ${cellCenterStyle}">BB</th>
                </tr>
            </thead>
        `;
        
        // Group scores by Header (I. Aqidah, II. Akhlak, etc.)
        const groupedData = {};
        let currentHeader = 'LAIN-LAIN';
        masterMulok.sub['Muatan Lokal'].forEach(item => {
            if (item.startsWith('I.') || item.startsWith('II.') || item.startsWith('III.') || item.startsWith('IV.')) {
                currentHeader = item;
                groupedData[currentHeader] = [];
            } else if (!item.startsWith('---')) {
                 const scoreData = muLokScores.find(s => s.text === item) || { text: item, score: '4' };
                 groupedData[currentHeader] = groupedData[currentHeader] || [];
                 if (!item.includes('KELOMPOK')) { // Exclude KELOMPOK headers from final table, although none in Mulok
                    groupedData[currentHeader].push(scoreData);
                 }
            }
        });

        let tbodyHtml = '<tbody>';
        let globalNo = 1; 

        Object.keys(groupedData).forEach((header) => {
            const items = groupedData[header];
            if (items.length === 0) return; // Skip empty headers

            // Header Kelompok (I. Aqidah, II. Akhlak, dll.)
            tbodyHtml += `
                <tr style="background-color: #e6f4ff;">
                    <td style="${cellCenterStyle} font-weight: bold; background-color: #f2f2f2; border: 1px solid black;">${header.split('.')[0]}</td>
                    <td colspan="5" style="${cellStyle} font-weight: bold; background-color: #f2f2f2; border: 1px solid black;">${header.replace(/^[IVX]+\.\s*/, '').trim()}</td>
                </tr>
            `;

            // Isi Capaian
            items.forEach((item) => {
                const score = item.score;
                tbodyHtml += `
                    <tr>
                        <td style="${cellCenterStyle}">${globalNo++}</td>
                        <td style="${cellStyle}">${item.text}</td>
                        <td style="${cellCenterStyle}">${score === '1' ? '‚úîÔ∏è' : ''}</td>
                        <td style="${cellCenterStyle}">${score === '2' ? '‚úîÔ∏è' : ''}</td>
                        <td style="${cellCenterStyle}">${score === '3' ? '‚úîÔ∏è' : ''}</td>
                        <td style="${cellCenterStyle}">${score === '4' ? '‚úîÔ∏è' : ''}</td>
                    </tr>
                `;
            });
        });
        tbodyHtml += '</tbody>';

        html = `<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">${headerHtml}${tbodyHtml}</table>`;
        return html;
    }


    // --- SUMMARY/RAPORT FUNCTIONS ---

    function getTtdHtml(peng, siswaDetail) {
        const ttdLine = '<div class="signature-line" style="height: 60px;"></div>'; // Placeholder for signature image/space
        const kelas = siswaDetail.kelas;

        return `
            <div class="raport-ttd">
                <table>
                    <tr>
                        <td style="width: 40%; padding-top: 40px;">
                            Orang Tua/Wali,
                            ${ttdLine}
                            <span style="border-bottom: 1px solid black; padding: 0 20px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        </td>
                        <td style="width: 30%;">
                            <p>${peng.tanggalRapor || 'Kota, Tgl Bulan Tahun'}</p>
                            Guru Kelas ${kelas},
                            ${ttdLine}
                            ${peng.guruKelas || 'Nama Guru'}
                            <div style="font-size: 11px;">NIP. ${peng.nipGuru || '-'}</div>
                        </td>
                        <td style="width: 30%;">
                            <p>&nbsp;</p>
                            Kepala Sekolah,
                            ${ttdLine}
                            ${peng.kepalaSekolah || 'Nama Kepala Sekolah'}
                            <div style="font-size: 11px;">NIP. ${peng.nipKepsek || '-'}</div>
                        </td>
                    </tr>
                </table>
            </div>
        `;
    }

    function getPhotoHtml(data, key) {
        const currentPhotos = data.photos[key] || [];
        let photoHtml = '';
        if (currentPhotos.length > 0) {
            currentPhotos.forEach(photo => {
                photoHtml += `<div class="foto-item-cetak"><img src="${photo}" alt="Dokumentasi"></div>`;
            });
        } else {
            photoHtml = '<p style="font-style: italic; color: #666;">Tidak ada dokumentasi foto.</p>';
        }
        return photoHtml;
    }

    function generateRaportHTML(nisn, jenis) {
        const siswaDetail = findSiswa(nisn);
        const data = atpData[nisn] || {};
        data.photos = photosData[nisn] || {};
        const peng = pengaturan;
        const semester = peng.semester || 'X';
        const tahunAjaran = peng.tahunAjaran || 'XXXX/XXXX';

        if (!siswaDetail) {
            return '<p style="text-align:center; color:red;">Data siswa tidak ditemukan.</p>';
        }

        // --- 1. HEADER ---
        let raportTitle = '';
        if (jenis === 'intra') {
            raportTitle = 'RAPORT INTRA KURIKULER';
        } else if (jenis === 'kokur') {
            raportTitle = 'RAPORT PROYEK PENGUATAN PROFIL PELAJAR PANCASILA (P5)';
        } else if (jenis === 'mulok') {
            raportTitle = 'RAPORT MUATAN LOKAL';
        }

        const logoHtml = peng.logoDataURL ? `<img src="${peng.logoDataURL}" alt="Logo" style="max-height: 80px; display: block; margin: 0 auto 10px;">` : '';
        const headerHtml = `
            <div class="raport-header" style="text-align: center; margin-bottom: 20px; line-height: 1.2;">
                ${logoHtml}
                <h3 style="font-size: 18px;">${peng.namaYayasan || 'NAMA YAYASAN'}</h3>
                <h2 style="font-size: 20px; font-weight: bold;">${peng.namaSekolah || 'NAMA SEKOLAH'}</h2>
                <h4 style="font-size: 14px; line-height: 1.2;">TAHUN AJARAN ${tahunAjaran}</h4>
                <p style="margin: 2px 0 0 0; font-size: 10px; line-height: 1.2;">
                    ${peng.alamatSekolah || 'Alamat Sekolah'} | ${peng.kontakSekolah || 'Kontak Sekolah'}
                </p>
            </div>
            <h4>${raportTitle}</h4>
        `;

        // --- 2. IDENTITAS SISWA ---
        const identityHtml = `
            <table class="raport-table-identity">
                <tr>
                    <td style="width: 35%;">Nama Peserta Didik</td>
                    <td style="width: 5%;">:</td>
                    <td style="width: 60%; font-weight: bold;">${siswaDetail.nama.toUpperCase()}</td>
                </tr>
                <tr>
                    <td>NISN</td>
                    <td>:</td>
                    <td>${siswaDetail.nisn || '-'}</td>
                </tr>
                <tr>
                    <td>Kelompok</td>
                    <td>:</td>
                    <td>${siswaDetail.kelas || '-'}</td>
                </tr>
                <tr>
                    <td>Semester/Tahun Ajaran</td>
                    <td>:</td>
                    <td>${semester} / ${tahunAjaran}</td>
                </tr>
            </table>
        `;
        
        // --- 3. COMMON ELEMENTS (Defined once for Intra) ---


         // Data Prestasi (Hanya digunakan di Intra)
        const prestasiHtml = `
            <div class="elemen-raport-block" style="margin-top: 25px; page-break-inside: avoid;">
                <h4 style="background-color: #f2f2f2; padding: 6px 10px; border-bottom: 1px solid #222; margin: 0; font-size: 15px; font-weight: bold;">Prestasi yang Dicapai</h4>
                <div style="padding: 10px;">
                    <p>${(siswaDetail.prestasi || 'Tidak ada prestasi yang menonjol.').replace(/\n/g, '<br>')}</p>
                </div>
            </div>
        `;
        
        // Data presensi (Hanya digunakan di Intra)
        const presensi = siswaDetail.presensi || { sakit: 0, izin: 0, alpha: 0 };
        const presensiHtml = `
            <div class="elemen-raport-block" style="margin-top: 25px; page-break-inside: avoid;">
                <h4 style="background-color: #F2F2F2; padding: 6px 10px; border-bottom: 1px solid #222; margin: 0; font-size: 15px; font-weight: bold;">KETERANGAN ABSENSI SISWA</h4>
                <div style="padding: 10px; text-align: center;">
                    <table class="presensi-table" style="margin: 10px auto;">
                        <tr><th>Keterangan</th><th>Jumlah Hari</th></tr>
                        <tr><td>Sakit</td><td>${presensi.sakit}</td></tr>
                        <tr><td>Izin</td><td>${presensi.izin}</td></tr>
                        <tr><td>Tanpa Keterangan</td><td>${presensi.alpha}</td></tr>
                    </table>
                </div>
            </div>
        `;

        // --- 4. BLOK RAPORT (Content Section) ---
        let elemenBlocks = '';
        let ttdHtml = ''; 

        if (jenis === 'intra') {
            const sum = data.intraSummary || {};
            const catatanOrtu = sum.catatanOrtu || '-';
            const catatanGuru = data.kokurSummary?.catatanGuru || '-'; // Catatan guru KoKur digunakan juga di Intra (sesuai template)
            
            const elemenKeys = [
                { key: 'agama', title: 'Nilai Agama & Budi Pekerti' },
                { key: 'jati', title: 'Jati Diri' },
                { key: 'literasi', title: 'Literasi, Matematika, Sains, Teknologi, Rekayasa & Seni' }
            ];

            let elemenHtml = '';
            elemenKeys.forEach(e => {
                const deskripsi = sum[e.key] || 'Deskripsi belum diisi/dibuat.';
                const photoHtml = getPhotoHtml(data, e.key);
                
                elemenHtml += `
                    <div class="elemen-raport-block" style="margin-top: 25px;">
                        <h4>${e.title}</h4>
                        <div class="elemen-content-block">
                            <div class="deskripsi-area">
                                <p>${deskripsi.replace(/\n/g, '<br>')}</p>
                            </div>
                            <div class="dokumentasi-area">
                                <h4 style="font-size: 15px; font-weight: bold; margin-bottom: 5px;">Dokumentasi Foto</h4>
                                <div class="raport-photos-block">
                                    ${photoHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            const catatanOrtuHtml = `
                <div class="elemen-raport-block" style="margin-top: 25px; page-break-inside: avoid;">
                    <h4 style="background-color: #f2f2f2; padding: 6px 10px; border-bottom: 1px solid #222; margin: 0; font-size: 15px; font-weight: bold;">Refleksi/Catatan Orang Tua</h4>
                    <div style="padding: 10px;">
                        <p>${catatanOrtu.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `;
            
            const catatanGuruHtml = `
                <div class="elemen-raport-block" style="margin-top: 25px; page-break-inside: avoid;">
                    <h4 style="background-color: #f2f2f2; padding: 6px 10px; border-bottom: 1px solid #222; margin: 0; font-size: 15px; font-weight: bold;">Catatan Guru (Umum)</h4>
                    <div style="padding: 10px;">
                        <p>${catatanGuru.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `;
            
            // INTRA: Masukkan semua blok (termasuk Presensi dan Prestasi)
            elemenBlocks = elemenHtml + catatanOrtuHtml + catatanGuruHtml + presensiHtml + prestasiHtml;

        } else if (jenis === 'kokur') {
            const sum = data.kokurSummary || {};
            const photoHtml = getPhotoHtml(data, 'kokur');

            // KOKUR: Hapus ${presensiHtml} dan ${prestasiHtml}
            elemenBlocks = `
                <div class="elemen-raport-block">
                    <h4>Deskripsi Capaian Proyek P5/P-RBL</h4>
                    <div class="elemen-content-block">
                        <div class="deskripsi-area">
                            <p>${(sum.deskripsi || '-').replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>

                    <div class="elemen-raport-block" style="margin-top: 30px;">
                            <h4>Dokumentasi Foto</h4>
                            <div class="raport-photos-block">
                            ${photoHtml}
                        </div>
                    </div>
                 
                    <div class="saran-area">
                            <h4 style="font-size: 15px; font-weight: bold; margin-top: 5px;">Refleksi/Catatan Guru</h4>
                                <p>${(sum.catatanGuru || '-').replace(/\n/g, '<br>')}</p>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            
        } else if (jenis === 'mulok') {
            const catatanGuruMulok = data.mulokSummary?.catatanGuru || '-';
            const muLokScores = data.MuLok || [];
            const photoHtml = getPhotoHtml(data, 'mulok');

            // MULOK: Hapus ${presensiHtml} dan ${prestasiHtml}
            elemenBlocks = getMulokRubricTable(muLokScores) + `
                <div class="elemen-raport-block" style="margin-top: 25px;">
                    <h4>Dokumentasi Foto</h4>
                    <div class="elemen-content-block" style="padding: 5px 10px;">
                        <div class="raport-photos-block">
                            ${photoHtml}
                        </div>
                    </div>
                
                    <div class="elemen-raport-block" style="margin-top: 25px;">
                    <h4>Catatan Guru Muatan Lokal</h4>
                    <div class="elemen-content-block" style="padding: 5px 10px;">
                        <p>${catatanGuruMulok.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            </div>
            `;
        }
        // =========================== AKHIR RAPORT MUATAN LOKAL ===========================

        // --- 5. TANDA TANGAN (KONDISIONAL) ---
        ttdHtml = (jenis === 'intra') ? getTtdHtml(peng, siswaDetail) : '';


        // --- 6. FINAL WRAPPER ---
        return `
            <div class="raport-container" id="raportContent">
                ${headerHtml}
                ${identityHtml}
                ${elemenBlocks}
                ${ttdHtml}
            </div>
        `;
    }

    // --- CETAK/PDF FUNCTIONS ---

    function prepareCetak(jenis) {
        const nisn = document.getElementById('pilihSiswaCetak').value;
        if (!nisn) {
            showToast('Pilih siswa terlebih dahulu.');
            return;
        }

        function prepareCetak(jenis) {
        const element = document.getElementById('previewCetak');
        if (!element) return;

        // Atur ukuran dan margin PDF agar proporsional
        const opt = {
            margin: [10, 10, 10, 10],
            filename: `raport_${jenis}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['css', 'legacy', 'avoid-all'] }
        };

        html2pdf().set(opt).from(element).save();
        }

        const htmlContent = generateRaportHTML(nisn, jenis);
        document.getElementById('previewCetak').innerHTML = htmlContent + `
            <div style="text-align:center; margin-top:20px; page-break-after: always;">
                <button class="btn" onclick="downloadRaportAsPDF('${nisn}', '${jenis}')" style="background:#007bff; padding:10px 15px;">‚¨áÔ∏è Download Raport sebagai PDF</button>
            </div>
        `;
    }
        const pdf = new jspdf.jsPDF({
        orientation: 'p',
        unit: 'mm',
        format: 'a4'
        });

        pdf.html(elementToPrint, {
        margin: [15, 15, 15, 15], // atas, kanan, bawah, kiri
        autoPaging: 'text',
        html2canvas: { scale: 0.7 },
        callback: function (pdf) {
            pdf.save(`${namaFile}.pdf`);
        }
        });

        
    function downloadRaportAsPDF(nisn, jenis) {
        const raportContent = document.getElementById('raportContent');
        if (!raportContent) {
            alert('Konten raport tidak ditemukan.');
            return;
        }
        const siswa = findSiswa(nisn);
        const fileName = `${siswa.nama}-${jenis}-Raport.pdf`;

        const {
            jsPDF
        } = window.jspdf;
        let y = 10; // Posisi awal Y (koordinat vertikal, dalam mm)
        const margin = 10; // Margin kiri dan kanan
        const marginBawah = 20; // Batas margin bawah sebelum pindah halaman
        const pageHeight = 297; // Tinggi kertas A4 dalam mm

        html2canvas(raportContent, {
            scale: 2,
            useCORS: true,
            allowTaint: true 
        }).then(canvas => {
            // 1. Akses jsPDF
            // ‚úÖ KODE YANG PALING STABIL UNTUK VERSI UMD
            const jsPDFConstructor = window.jsPDF || (window.jspdf && window.jspdf.jsPDF);
            if (!jsPDFConstructor) {
               Swal.fire('Error', 'Library jsPDF tidak ditemukan. Unduhan PDF gagal.', 'error');
                return;
            }
            
            // 2. Tentukan Ukuran & Margin
            const pdf = new jsPDFConstructor('p', 'mm', 'a4'); // ‚úÖ Menggunakan constructor yang sudah benar
            const pdfHeight = 297; // Tinggi A4 dalam mm
            const pdfWidth = 210; // Lebar A4 dalam mm
            const margin = 10; // Margin 10mm (1cm) yang akan digunakan oleh jsPDF

            // Lebar yang Tersedia untuk Konten (untuk Margin Kiri dan Kanan)
            const contentWidth = pdfWidth - (2 * margin); 

            // 3. Konversi Canvas ke Data Gambar
            const imgData = canvas.toDataURL('image/jpeg', 1.0); 
            const imgProps = pdf.getImageProperties(imgData);

            // Hitung Tinggi Total Gambar Canvas (Di-skala agar pas dengan contentWidth)
            let imgHeight = (imgProps.height * contentWidth) / imgProps.width;
            
            // Tinggi Halaman Efektif (Tinggi A4 - Margin Atas - Margin Bawah)
            const effectivePageHeight = pdfHeight - (2 * margin);
            
            let heightLeft = imgHeight; // Sisa tinggi gambar yang harus dicetak
            let pageCount = 1; // Penghitung halaman

            // 4. Proses Multi-Page PDF
            while (heightLeft > 0) {
                if (pageCount > 1) {
                    pdf.addPage();
        }

                // Hitung offset Y (geseran gambar ke atas)
                const currentYOffset = imgHeight - heightLeft;
                
                // Posisi Y di PDF: dimulai dari margin (10mm), dikurangi offset gambar yang sudah tercetak
                const position = margin - currentYOffset; 

                // Tambahkan gambar ke PDF: (Jenis Gambar, Margin Kiri, Posisi Y, Lebar Konten, Tinggi Gambar Penuh)
                pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight); 
                
                heightLeft -= effectivePageHeight; // Kurangi sisa tinggi yang sudah muat di halaman ini
                pageCount++;
        }

                // 5. Unduh file PDF
                const fileName = `Raport_${jenis}_${nisn}.pdf`;
                pdf.save(fileName); 
                Swal.close(); 
        });
            // Add first page
            pdf.addImage(imgData, 'JPEG', margin_mm, margin_mm + position, imgWidth, imgHeight);
            heightLeft -= (pageHeight - margin_mm); // Kurangi sisa tinggi kertas setelah margin atas

            // Add subsequent pages if needed
            let pageNum = 1;
            while (heightLeft > 0) {
                pdf.addPage();
                // Hitung posisi vertikal untuk halaman berikutnya
                position = - (imgHeight - heightLeft) + margin_mm; 
                pdf.addImage(imgData, 'JPEG', margin_mm, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - margin_mm); // Kurangi sisa tinggi kertas dengan memperhitungkan margin atas
                pageNum++;
            }

            pdf.save(fileName);
        };
    

        // --- PHOTO UPLOAD/RENDER FUNCTIONS ---

    function renderPhotos(nisn, areaKey, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        const currentPhotos = photosData[nisn]?.[areaKey] || [];
        
        // Input file
        const fileInputHtml = `
            <div class="foto-item" style="flex:0 0 160px;">
                <label for="fileInput-${areaKey}" style="cursor: pointer; display: block;">
                    <div class="foto-preview" style="height: 100px;">
                         <span>‚ûï Tambah Foto</span>
                    </div>
                </label>
                <input type="file" id="fileInput-${areaKey}" accept="image/*" style="display: none;" 
                       onchange="handlePhotoUpload('${nisn}', '${areaKey}', this.files[0])">
            </div>
        `;

        container.innerHTML += fileInputHtml;

        // Existing photos
        currentPhotos.forEach((photoUrl, index) => {
            const photoItem = document.createElement('div');
            photoItem.className = 'foto-item';
            photoItem.style.flex = '0 0 160px'; // Lebar tetap
            photoItem.innerHTML = `
                <div class="foto-preview" style="height: 100px;">
                    <img src="${photoUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <button class="btn" style="background: red; font-size: 12px; margin-top: 5px; padding: 4px 8px;" onclick="deletePhoto('${nisn}', '${areaKey}', ${index}, '${containerId}')">Hapus</button>
            `;
            container.appendChild(photoItem);
        });
    }


    function handlePhotoUpload(nisn, areaKey, file) {
        if (!file) return;

        // Cek batasan ukuran file (misalnya 2MB)
        if (file.size > 2097152) { 
            showToast('Ukuran file terlalu besar (Maks 2MB).');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const photoUrl = e.target.result;
            photosData[nisn] = photosData[nisn] || {};
            photosData[nisn][areaKey] = photosData[nisn][areaKey] || [];

            // Limit to 5 photos per section
            if (photosData[nisn][areaKey].length >= 5) {
                showToast('Maksimal 5 foto per bagian.');
                return;
            }

            photosData[nisn][areaKey].push(photoUrl);
            saveData(); 
            // Use the consistent ID from PHOTO_AREAS definition for re-render
            renderPhotos(nisn, areaKey, PHOTO_AREAS.find(a => a.key === areaKey).id);
            showToast('Foto berhasil diupload.');
        };
        reader.readAsDataURL(file);
    }

    function deletePhoto(nisn, areaKey, index, containerId) {
        if (photosData[nisn] && photosData[nisn][areaKey]) {
            photosData[nisn][areaKey].splice(index, 1);
            saveData();
            renderPhotos(nisn, areaKey, containerId);
        }
    }


    // --- SIMPAN DATA FINAL DESKRIPSI MANUAL (INTRA/KOKUR/MULOK) ---

    function simpanIntra() {
        if (!currentNisn) { showToast('Pilih siswa di menu ATP terlebih dahulu.'); return; }
        const nisn = currentNisn;
        atpData[nisn] = atpData[nisn] || {};
        atpData[nisn].intraSummary = atpData[nisn].intraSummary || {};
        
        // Update fields that can be manually edited
        atpData[nisn].intraSummary.agama = document.getElementById('deskAgama').value.trim();
        atpData[nisn].intraSummary.jatidiri = document.getElementById('deskJatidiri').value.trim();
        atpData[nisn].intraSummary.literasi = document.getElementById('deskLiterasi').value.trim();
        atpData[nisn].intraSummary.catatanOrtu = document.getElementById('catatanOrtu').value.trim();
        
        saveData();
        showToast('Deskripsi Intra Kurikuler berhasil disimpan.');
    }

    function simpanKokur() {
        if (!currentNisn) { showToast('Pilih siswa di menu ATP terlebih dahulu.'); return; }
        const nisn = currentNisn;
        atpData[nisn] = atpData[nisn] || {};
        atpData[nisn].kokurSummary = atpData[nisn].kokurSummary || {};
        
        // Update fields that can be manually edited
        atpData[nisn].kokurSummary.deskripsi = document.getElementById('deskKokur').value.trim();
        atpData[nisn].kokurSummary.catatanGuru = document.getElementById('catatanGuru').value.trim();
        
        saveData();
        showToast('Deskripsi Ko Kurikuler berhasil disimpan.');
    }

    function simpanMuatanLokal() {
        if (!currentNisn) { showToast('Pilih siswa di menu ATP terlebih dahulu.'); return; }
        const nisn = currentNisn;
        atpData[nisn] = atpData[nisn] || {};
        atpData[nisn].mulokSummary = atpData[nisn].mulokSummary || {};
        
        // Update fields that can be manually edited
        atpData[nisn].mulokSummary.deskripsi = document.getElementById('deskMulok').value.trim();
        atpData[nisn].mulokSummary.catatanGuru = document.getElementById('catatanGuruMulok').value.trim();
        
        saveData();
        showToast('Deskripsi Muatan Lokal berhasil disimpan.');
    }


    /* =========================== INITIALIZATION AND UNLOCK FIX =========================== */

    document.addEventListener("DOMContentLoaded", () => {
        loadData();
        applyPengaturanToUI();
        renderTimPengembang();
        fillSiswaSelects();
        tampilkanSiswa(); 

        // ============================================
        // ‚úÖ FIX PERBAIKAN MENU TIDAK BISA DIKLIK (UNLOCK)
        // ============================================
        // Menghapus kelas 'grayscale-mode' dari body untuk memastikan semua menu dapat diklik.
        // Ini memaksa aplikasi untuk berada dalam mode Developer (Unlocked) saat dimuat.
        document.body.classList.remove('grayscale-mode'); 
        document.getElementById('userBadge').innerHTML = '‚úÖ <span id="userName">Guru (Developer)</span>';
        document.getElementById('loginKeyIcon').textContent = 'üîì';
        
        // Set default jenis ATP saat pertama kali dimuat
        onJenisChangeATP(); 

        // Memastikan tampilan awal yang benar
        if (siswaData.length > 0) {
            showSection('dashboard');
        } else {
            showSection('dataSiswa');
        }
    });
// GANTI VARIABEL logoHtml ANDA DENGAN KODE INI DI DALAM FUNGSI generateRaportHTML
// Ini menggunakan gambar GIF transparan Base64 yang aman, untuk menghindari error CORS.
const logoHtml = `<img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width: 80px; height: auto;">`;
  </script>
</body>
</html>


